<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZapElite Pro - O Disparador Definitivo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Corre√ß√£o para Electron: impede que o 'module' confunda bibliotecas via CDN
        if (typeof module === 'object') {
            window.electronModule = module;
            module = undefined;
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        if (window.electronModule) module = window.electronModule;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #1ed760;
            --primary-hover: #1fdf64;
            --secondary: #3b82f6;
            --danger: #ef4444;
            --warning: #f5a623;
            --bg: #121212;
            --sidebar-bg: #000000;
            --card-bg: #181818;
            --card-header: #181818;
            --input-bg: #2a2a2a;
            --text-main: #ffffff;
            --text-muted: #b3b3b3;
            --border: #333333;
            --radius: 24px;
            --transition: all 0.2s ease;
            --success: #1ed760;
            --bg-dark: #0c1317;
        }

        /* Completely Hide Scrollbars for a Native Desktop App Look */
        * {
            scrollbar-width: none !important;
            /* Firefox */
            -ms-overflow-style: none !important;
            /* IE and Edge */
        }

        *::-webkit-scrollbar {
            display: none !important;
            /* Chrome, Safari and Opera */
            width: 0 !important;
            height: 0 !important;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]:focus {
            outline: none;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: rgba(30, 215, 96, 0.2);
            border-radius: 10px;
        }

        input[type=range]::-webkit-slider-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -7px;
            box-shadow: 0 0 10px rgba(30, 215, 96, 0.5);
        }

        input[type=range]:active::-webkit-slider-thumb {
            transform: scale(1.2);
        }

        /* Custom Radio Styling */
        .delay-card {
            flex: 1;
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-align: center;
            position: relative;
        }

        .delay-card:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-2px);
        }

        .delay-card.active {
            border-color: var(--primary);
            background: rgba(30, 215, 96, 0.05);
        }

        .custom-radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .active .custom-radio {
            border-color: var(--primary);
        }

        .custom-radio::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            transform: scale(0);
            transition: var(--transition);
            box-shadow: 0 0 10px rgba(30, 215, 96, 0.5);
        }

        .active .custom-radio::after {
            transform: scale(1);
        }

        .delay-card input[type="radio"] {
            display: none;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: radial-gradient(circle at top, #282828 0%, #121212 70%), #121212;
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
            flex-shrink: 0;
        }

        .sidebar-logo {
            margin-bottom: 50px;
            text-align: center;
        }

        .sidebar-logo img {
            max-width: 120px;
            filter: drop-shadow(0 0 10px rgba(0, 168, 132, 0.3));
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border-radius: 12px;
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-item:hover {
            background: #282828;
            color: #ffffff;
        }

        .nav-item.active {
            background: #282828;
            color: #ffffff;
        }

        .status-card {
            background: #121212;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 12px;
            margin-top: auto;
        }

        .status-card .label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
            font-weight: 800;
            margin-bottom: 8px;
        }

        .status-card .status-text {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-main);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tab-content {
            display: none;
            max-width: 900px;
            width: 100%;
            margin: 0;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .view-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 30px;
            letter-spacing: -1px;
        }

        /* Reusable Components from Web */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 16px 24px;
            background: var(--input-bg);
            border: 1px solid transparent;
            border-radius: 40px;
            color: var(--text-main);
            outline: none;
            transition: var(--transition);
            font-size: 0.95rem;
        }

        textarea {
            border-radius: 16px;
        }

        input:focus {
            background: #333333;
            border-color: #444444;
        }

        /* Wizard / Stepper Styles */
        .wizard-stepper {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
            padding: 0 10px;
        }

        .wizard-stepper::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50px;
            right: 50px;
            height: 2px;
            background: var(--border);
            z-index: 1;
        }

        .step-item {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            background: #222;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .step-item.active .step-circle {
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 0 15px rgba(30, 215, 96, 0.2);
            background: #222;
        }

        .step-item.completed .step-circle {
            background: var(--primary);
            border-color: var(--primary);
            color: #000;
        }

        .step-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .step-item.active .step-label {
            color: #fff;
        }

        .wizard-step {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .wizard-step.active {
            display: block;
        }

        .wizard-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        /* Multiple Messages UI */
        .msg-block {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .msg-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .remove-msg-btn {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .remove-msg-btn:hover {
            background: var(--danger);
            color: white;
        }

        .support-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: #25d366;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            z-index: 9999;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-decoration: none;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .support-fab:hover {
            transform: scale(1.1) rotate(5deg);
            background-color: #20ba59;
            box-shadow: 0 6px 25px rgba(37, 211, 102, 0.4);
        }

        .support-fab i {
            width: 32px;
            height: 32px;
        }

        /* Tooltip Simples */
        .support-fab::before {
            content: 'Suporte Elite';
            position: absolute;
            right: 75px;
            background: #282828;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            border: 1px solid #444;
        }

        .support-fab:hover::before {
            opacity: 1;
        }

        /* Switch Toggle Elite style */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        /* Tag Buttons */
        .tag-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .tag-btn {
            background: rgba(30, 215, 96, 0.05);
            color: var(--primary);
            border: 1px solid rgba(30, 215, 96, 0.2);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }

        .tag-btn:hover {
            background: var(--primary);
            color: #000;
        }

        /* Confirmation Modal Overlay */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 11000;
        }

        .confirm-overlay.active {
            display: flex;
        }

        .confirm-card {
            background: #181818;
            border: 1px solid #333;
            border-radius: 30px;
            width: 100%;
            max-width: 450px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
        }

        /* Lead source tabs */
        .source-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.03);
            padding: 5px;
            border-radius: 15px;
        }

        .source-tab {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .source-tab.active {
            background: #2a2a2a;
            color: var(--primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .support-fab::before {
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            border: 1px solid var(--border);
        }

        .support-fab:hover::before {
            opacity: 1;
        }

        option {
            background-color: #181818;
            color: #ffffff;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .row>* {
            flex: 1;
        }

        .btn {
            padding: 14px 32px;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: var(--transition);
            text-transform: none;
            letter-spacing: normal;
        }

        .btn-primary {
            background: var(--primary);
            color: #000000;
        }

        .btn-primary:hover {
            transform: scale(1.04);
            background: #1fdf64;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Progress Styles */
        .progress-box {
            background: var(--card-header);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .progress-bar {
            height: 8px;
            background: var(--input-bg);
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* Log Table */
        .log-table {
            width: 100%;
            border-collapse: collapse;
        }

        .log-table th {
            text-align: left;
            padding: 12px;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
        }

        .log-table td {
            padding: 16px 12px;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .status-sent {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary);
        }

        .status-sending {
            background: rgba(59, 130, 246, 0.1);
            color: var(--secondary);
        }

        .status-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .status-warning {
            background: rgba(245, 166, 35, 0.1);
            color: var(--warning);
        }

        /* Media Grid */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .media-btn {
            position: relative;
            overflow: hidden;
        }

        .media-btn input {
            position: absolute;
            opacity: 0;
            left: 0;
            top: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        /* Toast Moderno & Minimalista */
        #toast-container {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999999;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .toast {
            background: rgba(40, 40, 40, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: #ffffff;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            gap: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            min-width: max-content;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast i {
            width: 20px;
            height: 20px;
        }

        .toast.success i {
            color: var(--primary);
        }

        .toast.error i {
            color: var(--danger);
        }

        .toast.info i {
            color: var(--secondary);
        }

        .toast span {
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        /* --- ELITE ACTIVATION UI --- */
        .qr-card-elite {
            padding: 30px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            backdrop-filter: blur(12px);
            display: inline-block;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .qr-image-wrapper {
            background: #fff;
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 0 30px rgba(30, 215, 96, 0.2);
            position: relative;
            z-index: 1;
        }

        .success-glow {
            width: 120px;
            height: 120px;
            background: var(--primary);
            filter: blur(50px);
            opacity: 0.3;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            z-index: 0;
            animation: pulse-glow 2s infinite alternate;
        }

        @keyframes pulse-glow {
            from {
                opacity: 0.2;
                transform: translate(-50%, -50%) scale(0.9);
            }

            to {
                opacity: 0.4;
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        .status-badge.pulse {
            animation: badge-pulse 1.5s infinite;
        }

        @keyframes badge-pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(30, 215, 96, 0.4);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(30, 215, 96, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(30, 215, 96, 0);
            }
        }

        .elite-gradient-text {
            background: linear-gradient(135deg, #1ed760 0%, #3CB847 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card-elite {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 25px;
            border-radius: 20px;
            text-align: left;
            transition: transform 0.3s ease;
            position: relative;
        }

        .stat-card-elite:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.05);
        }

        .stat-card-elite i {
            width: 32px;
            height: 32px;
            margin-bottom: 15px;
            display: block;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 5px;
            color: #fff;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --- MODAL ESPEC√çFICO --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: #181818;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        /* --- LICENSE SCREEN --- */
        #license_screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0c1317;
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .license-card {
            background: #181818;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 40px;
            max-width: 450px;
            width: 100%;
            text-align: center;
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.8);
        }

        .license-card h2 {
            font-size: 2rem;
            letter-spacing: -1px;
            margin-bottom: 10px;
        }

        .license-input {
            width: 100%;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 1.1rem;
            text-align: center;
            margin: 20px 0;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
        }

        .license-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        #loading_gate {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0c1317;
            z-index: 100000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spin {
            animation: rotate 1s linear infinite;
            display: inline-block;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-logo">
            <img src="logo.png" alt="ZapElite">
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="showTab('home')">
                <i data-lucide="home"></i> Home
            </div>
            <div class="nav-item" onclick="showTab('sender')">
                <i data-lucide="send"></i> Disparador
            </div>

            <div class="nav-item" onclick="showTab('logs')">
                <i data-lucide="activity"></i> Logs de Envio
            </div>
            <div class="nav-item" onclick="showTab('settings')">
                <i data-lucide="settings"></i> Configura√ß√µes
            </div>
            <div class="nav-item" onclick="showTab('extractor')">
                <i data-lucide="users-round"></i> Extrator
            </div>

            <div class="nav-item" onclick="showTab('warmup')">
                <i data-lucide="zap"></i> Aquecimento
            </div>

            <div class="nav-item" onclick="showTab('help')">
                <i data-lucide="help-circle"></i> Ajuda
            </div>
        </div>

        <div class="status-card">
            <div id="sidebar_plan_label" class="label"><i data-lucide="shield-check"></i> Verificando Plano...</div>
            <div id="sidebar_expiry_label" class="status-text">Validando Licen√ßa...</div>
        </div>
    </div>

    <div class="main-content">
        <!-- TAB: HOME / DASHBOARD -->
        <div id="tab-home" class="tab-content active">
            <div class="welcome-section" style="margin-top: 20px;">
                <h1 style="font-size: 2.5rem; letter-spacing: -1.5px;">Dashboard <span
                        class="elite-gradient-text">Elite</span></h1>
                <p style="color: var(--text-muted); font-size: 1.1rem; margin-top: 10px;">Bem-vindo ao centro de comando
                    do seu ZapElite Pro.</p>
            </div>

            <div class="stat-grid">
                <div class="stat-card-elite">
                    <i data-lucide="send" style="color: var(--primary);"></i>
                    <div id="stat-total" class="stat-value">0</div>
                    <div class="stat-label">Total Enviados</div>
                </div>
                <div class="stat-card-elite">
                    <i data-lucide="check-circle-2" style="color: #1ed760;"></i>
                    <div id="stat-success" class="stat-value">0</div>
                    <div class="stat-label">Sucesso</div>
                </div>
                <div class="stat-card-elite">
                    <i data-lucide="alert-triangle" style="color: var(--danger);"></i>
                    <div id="stat-errors" class="stat-value">0</div>
                    <div class="stat-label">Falhas</div>
                </div>
            </div>

            <div class="card"
                style="margin-top: 30px; border: 1px dashed rgba(255,255,255,0.1); background: transparent;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div id="home_connection_indicator"
                        style="width: 12px; height: 12px; border-radius: 50%; background: #ff4444; box-shadow: 0 0 10px #ff4444;">
                    </div>
                    <div>
                        <h4 style="color: #fff; margin: 0;">Status da Inst√¢ncia</h4>
                        <p id="home_connection_text"
                            style="color: var(--text-muted); margin: 5px 0 0 0; font-size: 0.85rem;">WhatsApp
                            Desconectado</p>
                    </div>
                    <button class="btn btn-outline" onclick="showTab('settings')"
                        style="margin-left: auto; width: auto;">Configurar</button>
                </div>
            </div>
        </div>

        <!-- TAB: SENDER (DISPARADOR) -->
        <div id="tab-sender" class="tab-content">
            <h1 class="view-title">Disparador de Mensagens</h1>

            <!-- Wizard Stepper -->
            <div class="wizard-stepper">
                <div class="step-item active" id="step-idx-1">
                    <div class="step-circle">1</div>
                    <span class="step-label">Configura√ß√£o</span>
                </div>
                <div class="step-item" id="step-idx-2">
                    <div class="step-circle">2</div>
                    <span class="step-label">Conte√∫do</span>
                </div>
                <div class="step-item" id="step-idx-3">
                    <div class="step-circle">3</div>
                    <span class="step-label">Contatos e Envio</span>
                </div>
            </div>

            <!-- STEP 1: CONFIGURATION -->
            <div id="wizard-step-1" class="wizard-step active">
                <div class="card" style="margin-bottom: 25px;">
                    <label><i data-lucide="target"></i> Configura√ß√µes da Campanha</label>
                    <div class="row" style="gap: 15px; margin-top: 15px;">
                        <div class="form-group" style="flex: 2; margin: 0;">
                            <input type="text" id="campaignName" placeholder="Nome da Campanha (ex: Promo√ß√£o de Ver√£o)">
                        </div>
                        <div class="form-group" style="flex: 1; margin: 0;">
                            <select id="instanceSelector" style="height: 50px; border-radius: 40px; padding: 0 20px;">
                                <option value="user">WhatsApp Principal (01)</option>
                                <option value="partner">WhatsApp Secund√°rio (02)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i data-lucide="flask-conical"
                                style="width: 20px; height: 20px; color: var(--text-muted);"></i>
                            <span
                                style="font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Modo
                                de Teste</span>
                        </div>
                        <label class="switch" style="margin: 0;">
                            <input type="checkbox" id="testMode">
                            <span class="slider"></span>
                        </label>
                    </label>
                    <div id="testModeSettings" style="margin-top: 15px; display: none;">
                        <div class="form-group" style="margin: 0;">
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">Enviar apenas
                                uma c√≥pia para este n√∫mero antes de iniciar:</p>
                            <input type="text" id="testPhoneNumber" placeholder="Ex: 5511999999999">
                        </div>
                    </div>
                </div>

                <div class="wizard-nav">
                    <div></div>
                    <button class="btn btn-primary" onclick="goToWizardStep(2)"
                        style="width: auto; padding: 12px 30px;">Pr√≥ximo Passo <i
                            data-lucide="arrow-right"></i></button>
                </div>
            </div>

            <!-- STEP 2: CONTENT -->
            <div id="wizard-step-2" class="wizard-step">
                <div class="card">
                    <div class="form-group">
                        <label><i data-lucide="edit-3"></i> Vari√°veis de Personaliza√ß√£o</label>
                        <div class="tag-btns">
                            <button class="tag-btn" onclick="insertTag('{{saudacao}}')">üëã Sauda√ß√£o</button>
                            <button class="tag-btn" onclick="insertTag('{{nome}}')">üë§ Nome</button>
                            <button class="tag-btn" onclick="insertTag('{{dia_semana}}')">üìÖ Dia</button>
                            <button class="tag-btn" onclick="insertTag('{{hora}}')">üïí Hora</button>
                        </div>

                        <label
                            style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="display: flex; align-items: center; gap: 10px;"><i data-lucide="message-square"
                                    style="width: 16px; height: 16px;"></i> Mensagens da Campanha</span>
                            <button class="btn btn-outline" onclick="addMessageBlock()"
                                style="height: 32px; font-size: 0.7rem; padding: 0 12px;">+ Adicionar Mensagem</button>
                        </label>

                        <div id="messagesContainer" style="margin-top: 15px;">
                            <!-- Message blocks will be injected here -->
                            <div class="msg-block" id="msg-block-1">
                                <div class="msg-block-header">
                                    <span style="font-size: 0.75rem; font-weight: 800; color: var(--primary);">MENSAGEM
                                        #1</span>
                                </div>
                                <textarea class="campaign-message" rows="4"
                                    placeholder="Escreva sua primeira mensagem..."></textarea>
                            </div>
                        </div>

                        <div
                            style="margin-top: 25px; background: rgba(30, 215, 96, 0.03); padding: 20px; border-radius: 12px; border: 1px dashed var(--primary);">
                            <label style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                <span style="font-size: 0.85rem; font-weight: 700; color: #fff;">Intervalo entre Bal√µes
                                    (Anti-Ban)</span>
                                <span id="extraDelayValueDisplay"
                                    style="color: var(--primary); font-weight: 800; background: rgba(30, 215, 96, 0.1); padding: 2px 10px; border-radius: 6px;">0s</span>
                            </label>
                            <input type="range" id="extraDelay" min="0" max="60" value="0"
                                oninput="document.getElementById('extraDelayValueDisplay').innerText = this.value + 's'">
                            <p
                                style="font-size: 0.7rem; color: var(--text-muted); margin-top: 10px; text-align: center;">
                                Tempo de espera entre uma mensagem e outra para o mesmo contato.</p>
                        </div>

                        <div
                            style="display: flex; align-items: center; justify-content: space-between; margin-top: 15px; background: rgba(255,255,255,0.03); padding: 12px 20px; border-radius: 12px; border: 1px solid var(--border);">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label class="switch" style="margin: 0;">
                                    <input type="checkbox" id="useAI">
                                    <span class="slider"></span>
                                </label>
                                <span style="font-size: 0.85rem; font-weight: 700;">Usar I.A (Para variar cada
                                    mensagem)</span>
                            </div>
                        </div>
                    </div>

                    <label style="margin-top: 30px;"><i data-lucide="paperclip"></i> Anexar M√≠dias</label>
                    <div class="media-grid" style="margin-top: 10px;">
                        <div class="btn btn-outline media-btn"><i data-lucide="image"></i>Imagem <input type="file"
                                id="mediaImage" accept="image/*"></div>
                        <div class="btn btn-outline media-btn"><i data-lucide="mic"></i>√Åudio <input type="file"
                                id="mediaAudio" accept="audio/*"></div>
                        <div class="btn btn-outline media-btn"><i data-lucide="video"></i>V√≠deo <input type="file"
                                id="mediaVideo" accept="video/*"></div>
                        <div class="btn btn-outline media-btn"><i data-lucide="file"></i>Arquivo <input type="file"
                                id="mediaFile"></div>
                    </div>
                    <div id="mediaPreviewList" style="margin-top: 15px;"></div>
                </div>

                <div class="wizard-nav">
                    <button class="btn btn-outline" onclick="goToWizardStep(1)"
                        style="width: auto; padding: 12px 30px;"><i data-lucide="arrow-left"></i> Voltar</button>
                    <button class="btn btn-primary" onclick="goToWizardStep(3)"
                        style="width: auto; padding: 12px 30px;">Pr√≥ximo Passo <i
                            data-lucide="arrow-right"></i></button>
                </div>
            </div>

            <!-- STEP 3: AUDIENCE & SEND -->
            <div id="wizard-step-3" class="wizard-step">
                <div class="card">
                    <label><i data-lucide="database"></i> Origem dos Contatos</label>
                    <div class="source-tabs">
                        <div id="tabSourceXLSX" class="source-tab active" onclick="setLeadSource('xlsx')">Planilha</div>
                        <div id="tabSourceManual" class="source-tab" onclick="setLeadSource('manual')">Manual</div>
                        <div id="tabSourceGroup" class="source-tab" onclick="setLeadSource('group')">Grupos</div>
                    </div>

                    <div id="sourceXLSX" class="source-content">
                        <div class="btn btn-outline media-btn" style="width: 100%;">
                            <i data-lucide="upload"></i> Importar XLSX ou CSV
                            <input type="file" id="contactsFile" accept=".xlsx, .xls, .csv">
                        </div>
                    </div>

                    <div id="sourceManual" class="source-content" style="display: none;">
                        <textarea id="manualLeads" rows="4"
                            placeholder="Cole os n√∫meros aqui (ex: 5511999999999 ou Nome,5511...)"></textarea>
                        <button class="btn btn-outline" onclick="processManualLeads()"
                            style="margin-top: 10px; font-size: 0.8rem;">Processar e Carregar</button>
                    </div>

                    <div id="sourceGroup" class="source-content" style="display: none;">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button class="btn btn-outline" onclick="loadGroupsForSender()"
                                style="font-size: 0.8rem; flex: 1;">Buscar Grupos</button>
                            <select id="groupsSelectSender"
                                style="flex: 2; height: 50px; border-radius: 40px; padding: 0 20px;"></select>
                        </div>
                    </div>

                    <div id="contactsCount"
                        style="margin-top: 15px; color: var(--primary); font-weight: 800; font-size: 0.9rem; text-align: center;">
                        Nenhum contato carregado</div>
                </div>

                <div class="card">
                    <label><i data-lucide="calendar"></i> Agendamento (Opcional)</label>
                    <div style="display: flex; gap: 15px; margin-top: 10px;">
                        <input type="date" id="scheduleDate" style="flex: 1;">
                        <input type="time" id="scheduleTime" style="flex: 1;">
                    </div>
                </div>

                <div class="progress-box">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span id="progressStatus" style="font-weight: 700;">Pronto para iniciar</span>
                        <span id="progressPercent"
                            style="font-size: 1.5rem; font-weight: 800; color: var(--primary);">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressBar" class="progress-fill"></div>
                    </div>
                    <div id="progressDetailed" style="font-size: 0.85rem; color: var(--text-muted);">0 contatos na fila
                    </div>
                </div>

                <div class="row" style="gap: 15px;">
                    <button id="startBtn" class="btn btn-primary" onclick="requestCampaignConfirmation()"
                        style="flex: 2; height: 60px; font-size: 1.1rem;"><i data-lucide="play"></i> Iniciar
                        Disparos</button>
                    <button id="pauseBtn" class="btn btn-warning" onclick="togglePause()"
                        style="flex: 1; display: none;"><i data-lucide="pause"></i> Pausar</button>
                    <button id="stopBtn" class="btn btn-danger" onclick="stopSending()" style="flex: 1;" disabled><i
                            data-lucide="square"></i> Parar</button>
                </div>

                <div class="wizard-nav" style="margin-top: 20px;">
                    <button class="btn btn-outline" onclick="goToWizardStep(2)"
                        style="width: auto; padding: 12px 30px;"><i data-lucide="arrow-left"></i> Voltar ao
                        Conte√∫do</button>
                </div>
            </div>
        </div>

        <!-- TAB: CHAT -->


        <!-- TAB: LOGS -->
        <div id="tab-logs" class="tab-content">
            <h1 class="view-title">Logs de Atividade</h1>
            <div class="card" style="padding: 0; overflow: hidden;">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Membros</th>
                            <th>Campanha</th>
                            <th>Status</th>
                            <th>Hora</th>
                            <th>Mensagem</th>
                        </tr>
                    </thead>
                    <tbody id="logBody">
                        <tr>
                            <td colspan="5" style="text-align: center; color: var(--text-muted); padding: 50px;">Nenhum
                                log registrado.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TAB: SETTINGS (ATURA√á√ÉO/QRCODE) -->
        <div id="tab-settings" class="tab-content">
            <h1 class="view-title">Conex√µes ZapElite</h1>

            <div class="row" style="gap: 20px; align-items: stretch;">
                <div class="card"
                    style="flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: center; min-height: 520px; padding: 40px;">
                    <div id="setup_view_user">
                        <i data-lucide="smartphone"
                            style="width: 64px; height: 64px; color: var(--primary); margin-bottom: 25px;"></i>
                        <h2 style="font-size: 1.8rem; margin-bottom: 10px;">WhatsApp 01</h2>
                        <p style="color: var(--text-muted); margin-bottom: 30px; font-size: 1rem;">Conecte sua
                            primeira conta principal para disparos.</p>
                        <div class="form-group" style="max-width: 350px; margin: 0 auto 25px;">
                            <input type="text" id="name_user" placeholder="Nome da Inst√¢ncia 1"
                                style="text-align: center; height: 55px; font-size: 1rem;">
                        </div>
                        <button class="btn btn-primary" onclick="createAndConnect('user')"
                            style="width: auto; margin: 0 auto; padding: 15px 40px; font-size: 1rem;">
                            <i data-lucide="qr-code"></i> Gerar QR Code
                        </button>
                    </div>

                    <div id="qr_view_user" style="display: none;">
                        <div id="status_badge_user" style="margin-bottom: 20px;">
                            <span class="status-badge status-sending">Aguardando...</span>
                        </div>
                        <div id="qr_container_user"></div>
                        <div style="margin-top: 25px;">
                            <p style="font-size: 1rem; margin-bottom: 20px;">ID: <strong
                                    id="display_name_user"></strong>
                            </p>
                            <button class="btn btn-outline" onclick="logoutInstance('user')"
                                style="width: auto; margin: 0 auto; color: var(--danger); border-color: rgba(239, 68, 68, 0.2); padding: 12px 30px; font-size: 0.9rem;">
                                <i data-lucide="log-out"></i> Desconectar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- INSTANCE 2 -->
                <div class="card"
                    style="flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: center; min-height: 520px; padding: 40px;">
                    <div id="setup_view_partner">
                        <i data-lucide="smartphone"
                            style="width: 64px; height: 64px; color: #1ed760; margin-bottom: 25px;"></i>
                        <h2 style="font-size: 1.8rem; margin-bottom: 10px;">WhatsApp 02</h2>
                        <p style="color: var(--text-muted); margin-bottom: 30px; font-size: 1rem;">Adicione uma
                            segunda conta para aumentar sua escala.</p>
                        <div class="form-group" style="max-width: 350px; margin: 0 auto 25px;">
                            <input type="text" id="name_partner" placeholder="Nome da Inst√¢ncia 2"
                                style="text-align: center; height: 55px; font-size: 1rem;">
                        </div>
                        <button class="btn btn-primary" onclick="createAndConnect('partner')"
                            style="width: auto; margin: 0 auto; background: #1ed760; padding: 15px 40px; font-size: 1rem;">
                            <i data-lucide="qr-code"></i> Gerar QR Code
                        </button>
                    </div>

                    <div id="qr_view_partner" style="display: none;">
                        <div id="status_badge_partner" style="margin-bottom: 20px;">
                            <span class="status-badge status-sending">Aguardando...</span>
                        </div>
                        <div id="qr_container_partner"></div>
                        <div style="margin-top: 25px;">
                            <p style="font-size: 1rem; margin-bottom: 20px;">ID: <strong
                                    id="display_name_partner"></strong>
                            </p>
                            <button class="btn btn-outline" onclick="logoutInstance('partner')"
                                style="width: auto; margin: 0 auto; color: var(--danger); border-color: rgba(239, 68, 68, 0.2); padding: 12px 30px; font-size: 0.9rem;">
                                <i data-lucide="log-out"></i> Desconectar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <label style="margin: 0;"><i data-lucide="refresh-ccw"></i> Atualiza√ß√£o de Software</label>
                    <span id="current-version-tag"
                        style="background: rgba(255,255,255,0.05); padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; color: var(--text-muted); border: 1px solid var(--border);">v1.0.14</span>


                </div>

                <div style="display: flex; gap: 15px; align-items: center;">
                    <p style="font-size: 0.8rem; color: var(--text-muted); flex: 1;">Mantenha seu ZapElite sempre
                        atualizado para garantir o acesso √†s √∫ltimas funcionalidades e seguran√ßa.</p>
                    <button class="btn btn-outline" style="width: auto; padding: 10px 20px; font-size: 0.8rem;"
                        onclick="checkForUpdatesManually()">
                        <i data-lucide="search" style="width: 14px; height: 14px;"></i> Verificar
                    </button>
                </div>
            </div>

            <div class="card">
                <label><i data-lucide="zap"></i> Velocidade de Disparo</label>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 25px;">Escolha o modo de intervalo
                    ideal para seu chip.</p>

                <div class="row" style="gap: 15px; margin-bottom: 20px;">
                    <div class="delay-card" id="fixedDelayOption" onclick="selectDelayMode('fixed')">
                        <div class="custom-radio"></div>
                        <i data-lucide="timer" style="width: 24px; height: 24px; color: var(--text-muted);"></i>
                        <span style="font-size: 0.85rem; font-weight: 700;">Delay Fixo</span>
                        <input type="radio" name="delayMode" id="modeFixed" value="fixed">
                    </div>
                    <div class="delay-card active" id="randomDelayOption" onclick="selectDelayMode('random')">
                        <div class="custom-radio"></div>
                        <i data-lucide="shuffle" style="width: 24px; height: 24px; color: var(--primary);"></i>
                        <span style="font-size: 0.85rem; font-weight: 700;">Delay Inteligente</span>
                        <input type="radio" name="delayMode" id="modeRandom" value="random" checked>
                    </div>
                </div>

                <!-- SLIDER FOR FIXED DELAY -->
                <div id="sectionFixedDelay"
                    style="display: none; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="font-size: 0.85rem; font-weight: 600;">Valor do Delay</span>
                        <span id="fixedDelayValueDisplay"
                            style="color: var(--primary); font-weight: 800; background: rgba(139, 92, 246, 0.1); padding: 2px 10px; border-radius: 6px;">15s</span>
                    </div>
                    <input type="range" id="fixedInterval" min="5" max="120" value="15"
                        oninput="document.getElementById('fixedDelayValueDisplay').innerText = this.value + 's'">
                    <p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 10px; text-align: center;">
                        Intervalo exato entre cada mensagem enviada.</p>
                </div>

                <!-- SLIDER FOR RANDOM DELAY -->
                <div id="sectionRandomDelay"
                    style="padding: 20px; background: rgba(255,255,255,0.02); border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="font-size: 0.85rem; font-weight: 600;">Delay M√°ximo Vari√°vel</span>
                        <span id="randomDelayValueDisplay"
                            style="color: var(--primary); font-weight: 800; background: rgba(139, 92, 246, 0.1); padding: 2px 10px; border-radius: 6px;">20s</span>
                    </div>
                    <input type="range" id="randomInterval" min="10" max="300" value="20"
                        oninput="document.getElementById('randomDelayValueDisplay').innerText = this.value + 's'">
                    <p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 10px; text-align: center;">O
                        sistema escolher√° um tempo aleat√≥rio entre 5s e este valor.</p>
                </div>

            </div>
        </div>

        <!-- TAB: EXTRACTOR -->
        <div id="tab-extractor" class="tab-content">
            <h1 class="view-title">Extrator de Contatos</h1>
            <p style="color: var(--text-muted); margin-bottom: 30px;">Extraia contatos de Grupos e Comunidades
                vinculados ao seu WhatsApp.</p>

            <div class="card">
                <!-- Seletor em linha separada no topo -->
                <div class="form-group" style="margin-bottom: 25px;">
                    <label
                        style="font-size: 0.75rem; text-transform: uppercase; margin-bottom: 12px; display: block; color: var(--primary); font-weight: 700; letter-spacing: 1px;">
                        <i data-lucide="smartphone"
                            style="width: 14px; height: 14px; vertical-align: middle; margin-right: 5px;"></i>
                        Selecione a conta para extra√ß√£o
                    </label>
                    <select id="extractorInstanceSelector"
                        style="height: 55px; border-radius: 15px; padding: 0 25px; width: 100%; background: rgba(255,255,255,0.03); border: 1px solid var(--border); color: #fff; font-size: 1rem; cursor: pointer; transition: var(--transition);">
                        <option value="user">WhatsApp Principal (01)</option>
                        <option value="partner">WhatsApp Secund√°rio (02)</option>
                    </select>
                </div>

                <!-- Bot√µes de A√ß√£o em uma grade -->
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px;">
                    <button class="btn btn-primary" onclick="loadWhatsAppGroups()"
                        style="height: 55px; border-radius: 15px;">
                        <i data-lucide="refresh-cw"></i> Listar Grupos / Comunidades
                    </button>
                    <button id="downloadExtractBtn" class="btn btn-outline" disabled onclick="exportExtractedContacts()"
                        style="height: 55px; border-radius: 15px;">
                        <i data-lucide="download"></i> Baixar XLSX
                    </button>
                    <button id="copyExtractBtn" class="btn btn-outline" disabled onclick="copyExtractedContacts()"
                        style="height: 55px; border-radius: 15px;">
                        <i data-lucide="copy"></i> Copiar Lista
                    </button>
                </div>
            </div>

            <div id="groups_container"
                style="max-height: 400px; overflow-y: auto; background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid var(--border);">
                <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                    <i data-lucide="info" style="margin-bottom: 15px; opacity: 0.5;"></i>
                    <p>Clique em listar para buscar seus grupos.</p>
                </div>
            </div>
            <div id="extraction_stats" style="display: none; margin-top: 20px;">
                <div class="stat-card-elite" style="padding: 15px;">
                    <p style="font-size: 0.8rem; color: var(--text-muted);">Contatos Encontrados</p>
                    <div id="extracted_count" style="font-size: 1.5rem; font-weight: 800; color: var(--primary);">0
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: WARMUP -->
        <div id="tab-warmup" class="tab-content">
            <h1 class="view-title">Aquecimento <span class="elite-gradient-text">Elite</span></h1>
            <p style="color: var(--text-muted); margin-bottom: 30px;">Mature seus n√∫meros atrav√©s de conversas simuladas
                e evite bloqueios.</p>

            <div class="row" style="gap: 20px; align-items: stretch;">
                <!-- Painel de Controle -->
                <div class="card" style="flex: 1.2;">
                    <h3 style="color: #fff; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i data-lucide="settings-2" style="color: var(--primary);"></i> Configura√ß√µes do Motor
                    </h3>

                    <div class="form-group">
                        <label>Modo de Aquecimento</label>
                        <div
                            style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid var(--border);">
                            <p style="font-size: 0.8rem; color: var(--primary); font-weight: 700; margin-bottom: 5px;">
                                MODO PING-PONG ATIVO</p>
                            <p style="font-size: 0.75rem; color: var(--text-muted);">Suas duas inst√¢ncias conversar√£o
                                entre si automaticamente se ambas estiverem conectadas.</p>
                        </div>
                    </div>

                    <div
                        style="background: rgba(30, 215, 96, 0.05); border: 1px solid var(--primary); padding: 15px; border-radius: 12px; margin-top: 20px;">
                        <p style="font-size: 0.8rem; color: #fff; margin-bottom: 5px; font-weight: 700;">
                            <i data-lucide="zap"
                                style="width: 14px; height: 14px; vertical-align: middle; margin-right: 5px; color: var(--primary);"></i>
                            Ping-Pong Inteligente
                        </p>
                        <p style="font-size: 0.7rem; color: var(--text-muted); line-height: 1.4;">
                            O motor detectar√° automaticamente as inst√¢ncias conectadas em <b>Configura√ß√µes</b> para
                            realizar a matura√ß√£o m√∫tua.
                        </p>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>Velocidade do Motor</label>
                        <select id="warmup_speed"
                            style="height: 55px; border-radius: 15px; padding: 0 20px; width: 100%; background: rgba(255,255,255,0.02); border: 1px solid var(--border); color: #fff; cursor: pointer;">
                            <option value="human">Modo Humano (Lento/Seguro)</option>
                            <option value="fast">Veloz (M√©dio)</option>
                            <option value="turbo" selected>Turbo Elite (Acelerado)</option>
                            <option value="caotic">Ca√≥tico (Aleat√≥rio Total)</option>
                        </select>
                    </div>

                    <div class="row" style="margin-top: 30px; gap: 15px;">
                        <button id="warmupStartBtn" class="btn btn-primary" onclick="startWarmup()" style="flex: 2;">
                            <i data-lucide="play"></i> Ligar Motor
                        </button>
                        <button id="warmupStopBtn" class="btn btn-danger" onclick="stopWarmup()" style="flex: 1;"
                            disabled>
                            <i data-lucide="square"></i> Parar
                        </button>
                    </div>
                </div>

                <!-- Dashboard de Status -->
                <div style="flex: 1; display: flex; flex-direction: column; gap: 20px;">
                    <div class="card" id="warmup_status_box"
                        style="display: none; border-left: 4px solid var(--primary);">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <i data-lucide="refresh-cw" class="spin"
                                style="color: var(--primary); width: 24px; height: 24px;"></i>
                            <div>
                                <h4 id="warmup_status_text" style="color: #fff; margin: 0;">Motor Iniciando...</h4>
                                <p id="warmup_status_detail"
                                    style="font-size: 0.75rem; color: var(--text-muted); margin: 0;">Preparando
                                    ambiente...</p>
                            </div>
                        </div>
                    </div>

                    <div class="stat-grid" style="grid-template-columns: repeat(2, 1fr); margin-top: 0;">
                        <div class="stat-card-elite" style="padding: 15px;">
                            <p style="font-size: 0.7rem; color: var(--text-muted);">Mensagens</p>
                            <div id="warmup-stat-sent" style="font-size: 1.4rem; font-weight: 800; color: #fff;">0</div>
                        </div>
                        <div class="stat-card-elite" style="padding: 15px;">
                            <p style="font-size: 0.7rem; color: var(--text-muted);">Tempo</p>
                            <div id="warmup-stat-time" style="font-size: 1.4rem; font-weight: 800; color: #fff;">0m
                            </div>
                        </div>
                    </div>

                    <div class="card" style="text-align: center; padding: 20px;">
                        <p
                            style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">
                            √çndice de Matura√ß√£o</p>
                        <div id="warmup-stat-trust"
                            style="font-size: 1.8rem; font-weight: 900; color: #ff4444; margin: 10px 0;">FRIO</div>
                        <div
                            style="height: 6px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden;">
                            <div id="warmup-trust-bar"
                                style="width: 10%; height: 100%; background: var(--primary); transition: width 0.5s;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs de Tempo Real -->
            <div class="card" style="margin-top: 20px; padding: 0; overflow: hidden; border: 1px solid var(--border);">
                <div
                    style="padding: 15px 20px; background: rgba(255,255,255,0.02); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border);">
                    <span style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted);">Monitor de Atividade em
                        Tempo Real</span>
                    <i data-lucide="radio" style="width: 14px; height: 14px; color: var(--primary);"></i>
                </div>
                <div id="warmup_logs"
                    style="height: 200px; overflow-y: auto; padding: 20px; font-family: 'Consolas', monospace; font-size: 0.85rem; background: #0c0c0c;">
                    <div style="color: #444;">Aguardando in√≠cio do motor...</div>
                </div>
            </div>
        </div>

        <!-- TAB: HELP -->
        <div id="tab-help" class="tab-content">
            <h1 class="view-title">Central de Ajuda</h1>

            <div class="card" style="margin-bottom: 20px;">
                <h2 class="elite-gradient-text" style="font-size: 1.4rem; margin-bottom: 10px;">Guia de Uso R√°pido
                </h2>
                <p style="color: var(--text-muted); font-size: 0.95rem;">Siga os passos abaixo para realizar seus
                    disparos com m√°xima efici√™ncia e seguran√ßa.</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                <div class="stat-card-elite">
                    <i data-lucide="smartphone" style="color: var(--primary);"></i>
                    <h4 style="color: #fff; margin-bottom: 8px;">1. Gest√£o de Inst√¢ncias</h4>
                    <p style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">O ZapElite permite
                        conectar
                        at√©
                        <strong>duas contas (Principal e Secund√°ria)</strong>. Configure nomes √∫nicos para cada uma
                        e
                        gerencie disparos independentes ou simult√¢neos.
                    </p>
                </div>

                <div class="stat-card-elite">
                    <i data-lucide="file-text" style="color: var(--primary);"></i>
                    <h4 style="color: #fff; margin-bottom: 8px;">2. Importa√ß√£o & JIDs</h4>
                    <p style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">Importe listas via
                        CSV/XLSX. O
                        sistema detecta automaticamente n√∫meros tradicionais e
                        <strong>IDs de privacidade (LIDs/JIDs)</strong>, garantindo que ningu√©m fique de fora.
                    </p>
                </div>

                <div class="stat-card-elite">
                    <i data-lucide="brain" style="color: var(--primary);"></i>
                    <h4 style="color: #fff; margin-bottom: 8px;">3. IA Anti-Ban & Tags</h4>
                    <p style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">Use as tags
                        <strong>{{saudacao}}</strong>, <strong>{{dia_semana}}</strong> e <strong>{{hora}}</strong>.
                        A IA
                        reescreve padr√µes de envio para tornar cada mensagem √∫nica e humana.
                    </p>
                </div>

                <div class="stat-card-elite">
                    <i data-lucide="share-2" style="color: var(--primary);"></i>
                    <h4 style="color: #fff; margin-bottom: 8px;">4. Multi-M√≠dias Elite</h4>
                    <p style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">Envie <strong>Imagens,
                            V√≠deos,
                            Arquivos</strong> e <strong>√Åudios Gravados (PTT)</strong>. Anexe m√∫ltiplos arquivos em
                        uma
                        √∫nica campanha para m√°xima convers√£o.</p>
                </div>

                <div class="stat-card-elite">
                    <i data-lucide="users" style="color: var(--primary);"></i>
                    <h4 style="color: #fff; margin-bottom: 8px;">5. Extrator Inteligente</h4>
                    <p style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">Extraia membros de
                        <strong>Grupos e Comunidades</strong> selecionando a conta desejada. Exporte em XLSX ou
                        copie a
                        lista com um clique.
                    </p>
                </div>

                <div class="stat-card-elite" style="border-color: var(--primary);">
                    <i data-lucide="zap" style="color: var(--primary);"></i>
                    <h4 style="color: #fff; margin-bottom: 8px;">6. Aquecimento (Warmup)</h4>
                    <p style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">Aumente a matura√ß√£o do
                        seu
                        chip simulando conversas humanas entre suas contas, preparando seu n√∫mero para disparos de
                        alta
                        escala.</p>
                </div>
            </div>

            <div class="card"
                style="margin-top: 20px; border-left: 4px solid var(--primary); background: rgba(30, 215, 96, 0.02);">
                <h4 style="color: #fff; margin-bottom: 10px;"><i data-lucide="shield-check"
                        style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px; color: var(--primary);"></i>
                    Protocolo de Seguran√ßa Elite</h4>
                <ul
                    style="color: var(--text-muted); font-size: 0.85rem; padding-left: 20px; line-height: 1.6; margin: 0;">
                    <li>Utilize o <strong>Delay Inteligente</strong> em campanhas acima de 50 contatos.</li>
                    <li>Ative o <strong>Delay Extra</strong> (10-30s) para simular o tempo de leitura humana.</li>
                    <li>Nunca envie mensagens sem o consentimento do destinat√°rio para evitar den√∫ncias manuais.
                    </li>
                    <li>Mantenha as inst√¢ncias conectadas e est√°veis durante o processamento da fila.</li>
                </ul>
            </div>
        </div>


        <!-- BOT√ÉO SUPORTE WHATSAPP -->
        <a href="#"
            onclick="event.preventDefault(); require('electron').shell.openExternal('https://wa.me/5537999056159')"
            class="support-fab" id="supportBtn">
            <i data-lucide="message-circle"></i>
        </a>
        <div id="license_screen" style="display: none;">
            <div class="license-card">
                <img src="logo.png" style="width: 80px; margin-bottom: 20px;">
                <h2 class="elite-gradient-text">ATIVAR LICEN√áA</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Insira seu c√≥digo de acesso para
                    desbloquear o
                    ZapElite Pro.</p>

                <input type="text" id="license_input_field" class="license-input" placeholder="ELITE-XXXX-XXXX-XXXX">

                <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="activateLicense()"
                        style="width: auto; padding: 16px 40px;">
                        <i data-lucide="unlock"></i> Ativar Software
                    </button>
                </div>

                <p style="font-size: 0.8rem; color: var(--text-muted);">Precisa de ajuda ou nova licen√ßa?<br>
                    <a href="mailto:arkanintelligence@gmail.com"
                        style="color: var(--primary); text-decoration: none;">arkanintelligence@gmail.com</a>
                </p>
            </div>
        </div>

        <!-- CARREGAMENTO INICIAL -->
        <div id="loading_gate">
            <i data-lucide="loader-2" class="spin" style="color: var(--primary); width: 32px; height: 32px;"></i>
            <p
                style="color: var(--text-muted); font-size: 0.8rem; margin-top: 15px; letter-spacing: 2px; text-transform: uppercase;">
                Autenticando...</p>
        </div>

        <div id="toast-container"></div>

    </div>

    <!-- MODAL DE ATUALIZA√á√ÉO (ELITE UPDATE) -->
    <div id="updateModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="success-glow" style="background: var(--secondary); opacity: 0.2;"></div>
            <i data-lucide="sparkles"
                style="width: 48px; height: 48px; color: var(--secondary); margin-bottom: 15px;"></i>
            <h2 class="elite-gradient-text" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                Nova
                Vers√£o Dispon√≠vel!</h2>
            <p id="update_version_text" style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">v1.1.0
                dispon√≠vel para download</p>

            <div id="release_notes"
                style="text-align: left; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin: 20px 0; max-height: 150px; overflow-y: auto; font-size: 0.85rem; border: 1px solid rgba(255,255,255,0.05);">
                <span style="color: var(--secondary); font-weight: 700;">Novidades desta vers√£o:</span>
                <ul id="notes_list" style="padding-left: 20px; margin-top: 8px; color: var(--text-muted);">
                    <li>Carregando notas da vers√£o...</li>
                </ul>
            </div>

            <div id="update_progress_container" style="display: none; margin-bottom: 20px;">
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">Baixando atualiza√ß√£o...
                </p>
                <div class="progress-container">
                    <div id="update_progress_bar" class="progress-bar" style="width: 0%; background: var(--secondary);">
                    </div>
                </div>
            </div>

            <div class="modal-actions" id="update_actions">
                <button class="btn btn-outline" id="skip_update_btn" onclick="closeUpdateModal()">Depois</button>
                <button class="btn btn-primary" style="background: var(--secondary); color:#fff"
                    onclick="startSoftwareUpdate()">Atualizar Agora</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO (EXIT/DELETE) -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <i data-lucide="alert-triangle"
                style="width: 48px; height: 48px; color: var(--danger); margin-bottom: 15px;"></i>
            <h2 id="modalTitle" style="color: #fff; font-size: 1.4rem;">Confirmar A√ß√£o?</h2>
            <p id="modalMessage" style="color: var(--text-muted); font-size: 0.9rem; margin: 15px 0;">Esta a√ß√£o n√£o
                pode
                ser desfeita.</p>

            <div class="modal-actions" style="margin-top: 25px;">
                <button class="btn btn-outline" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="modalConfirmBtn"
                    style="background: var(--danger); color: #fff;">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- Configura√ß√µes Blindadas via Config Interno ---
        const zapConfig = require('./config.js');
        const SUPABASE_URL = zapConfig.SUPABASE_URL;
        const SUPABASE_KEY = zapConfig.SUPABASE_KEY;
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const SAAS_CONFIG = {
            baseUrl: zapConfig.EVOLUTION_BASE_URL,
            globalKey: zapConfig.EVOLUTION_GLOBAL_KEY,
            openaiKey: zapConfig.OPENAI_KEY
        };

        let userInstance = {
            name: localStorage.getItem('zapelite_user_name') || '',
            token: localStorage.getItem('zapelite_user_token') || '',
            connected: false
        };

        let partnerInstance = {
            name: localStorage.getItem('zapelite_partner_name') || '',
            token: localStorage.getItem('zapelite_partner_token') || '',
            connected: false
        };

        function updateDashboardStatus() {
            const hText = document.getElementById('home_connection_text');
            const hInd = document.getElementById('home_connection_indicator');
            if (!hText || !hInd) return;

            let connectedCount = 0;
            if (userInstance.connected) connectedCount++;
            if (partnerInstance.connected) connectedCount++;

            if (connectedCount === 0) {
                hInd.style.background = '#ff4444';
                hInd.style.boxShadow = '0 0 10px #ff4444';
                hText.innerText = 'Nenhuma Inst√¢ncia Conectada';
            } else if (connectedCount === 1) {
                hInd.style.background = '#1ed760';
                hInd.style.boxShadow = '0 0 10px #1ed760';
                hText.innerText = userInstance.connected ? 'WhatsApp 01 Conectado' : 'WhatsApp 02 Conectado';
            } else if (connectedCount === 2) {
                hInd.style.background = '#1ed760';
                hInd.style.boxShadow = '0 0 20px #1ed760';
                hText.innerText = '2 Inst√¢ncias Conectadas (Modo Elite)';
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const target = document.getElementById('tab-' + tabId);
            if (target) target.classList.add('active');
            event.currentTarget.classList.add('active');

            if (tabId === 'settings' && userInstance.token) {
                checkInstanceStatus();
            }
        }

        // --- LOGICA DE LICENCIAMENTO ---
        const { execSync } = require('child_process');
        function getHWID() {
            try {
                const output = execSync('wmic csproduct get uuid').toString();
                // Filtra linhas vazias e pega a segunda linha (o UUID real)
                const parts = output.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0 && !l.includes('UUID'));
                return parts[0] || require('os').hostname();
            } catch (e) {
                return require('os').hostname() + '-' + require('os').userInfo().username;
            }
        }

        async function checkLicenseStatus() {
            const savedKey = localStorage.getItem('zapelite_license_key');
            const currentHWID = getHWID();

            if (!savedKey) {
                document.getElementById('loading_gate').style.display = 'none';
                document.getElementById('license_screen').style.display = 'flex';
                return;
            }

            try {
                const { data, error } = await _supabase
                    .from('licenses')
                    .select('*')
                    .eq('key', savedKey)
                    .single();

                // Se a licen√ßa n√£o existe ou n√£o est√° ativa
                if (error || !data || !data.is_active) {
                    localStorage.removeItem('zapelite_license_key');
                    document.getElementById('loading_gate').style.display = 'none';
                    document.getElementById('license_screen').style.display = 'flex';
                    return;
                }

                // Se est√° ativa mas falta dados vitais (HWID ou Datas), for√ßamos re-v√≠nculo
                if (!data.activated_at || !data.device_id) {
                    document.getElementById('loading_gate').style.display = 'none';
                    document.getElementById('license_screen').style.display = 'flex';
                    return;
                }

                // TRAVA DE HWID: Bloqueia se o HWID n√£o bater com o registrado
                if (data.device_id && data.device_id !== currentHWID) {
                    showToast("Licen√ßa vinculada a outro PC!", "error");
                    localStorage.removeItem('zapelite_license_key');
                    setTimeout(() => window.location.reload(), 3000);
                    return;
                }

                // Verifica expira√ß√£o (se n√£o for Vitalicio)
                if (data.plan_type !== 'Vitalicio' && data.expires_at) {
                    if (new Date(data.expires_at) < new Date()) {
                        showToast("Sua licen√ßa expirou!", "error");
                        localStorage.removeItem('zapelite_license_key');
                        window.location.reload();
                        return;
                    }
                }

                // Sucesso! Atualiza a interface
                document.getElementById('loading_gate').style.opacity = '0';
                setTimeout(() => document.getElementById('loading_gate').style.display = 'none', 500);
                document.getElementById('license_screen').style.display = 'none';

                document.getElementById('sidebar_plan_label').innerHTML = `<i data-lucide="shield-check"></i> Plano: ${data.plan_type}`;
                const expiryText = data.plan_type === 'Vitalicio' ? 'Acesso Vital√≠cio' : `Expira em: ${new Date(data.expires_at).toLocaleDateString()}`;
                document.getElementById('sidebar_expiry_label').innerText = expiryText;
                lucide.createIcons();

            } catch (e) {
                console.error("Erro na valida√ß√£o:", e);
                showToast("Erro ao validar licen√ßa. Tente novamente.", "error");
            }
        }

        async function activateLicense() {
            const key = document.getElementById('license_input_field').value.trim().toUpperCase();
            if (!key) return showToast("Digite sua chave de licen√ßa!", "error");

            const currentHWID = getHWID();
            showToast("Validando hardware...", "info");

            try {
                const { data, error } = await _supabase
                    .from('licenses')
                    .select('*')
                    .eq('key', key)
                    .single();

                if (error || !data) {
                    return showToast("Chave inv√°lida ou inexistente.", "error");
                }

                // Se a chave j√° tem um ID de dispositivo e n√£o √© este, bloqueia
                if (data.device_id && data.device_id !== currentHWID) {
                    return showToast("Esta licen√ßa j√° est√° em uso em outro PC.", "error");
                }

                // Se a chave j√° tem um ID de dispositivo, est√° ativa e tem data, deixa entrar direto
                if (data.activated_at && data.is_active && data.device_id) {
                    localStorage.setItem('zapelite_license_key', key);
                    showToast("Bem-vindo de volta!", "success");
                    setTimeout(() => location.reload(), 1500);
                    return;
                }

                // Primeira ativa√ß√£o: calcular expira√ß√£o e VINCULAR HWID
                let expiresAt = new Date();
                if (data.plan_type === 'Mensal') expiresAt.setMonth(expiresAt.getMonth() + 1);
                else if (data.plan_type === 'Trimestral') expiresAt.setMonth(expiresAt.getMonth() + 3);
                else if (data.plan_type === 'Anual') expiresAt.setFullYear(expiresAt.getFullYear() + 1);
                else if (data.plan_type === 'Trial') expiresAt.setDate(expiresAt.getDate() + 3);
                else if (data.plan_type === 'Vitalicio') expiresAt = null;

                const { error: updateError } = await _supabase
                    .from('licenses')
                    .update({
                        activated_at: new Date().toISOString(),
                        expires_at: expiresAt ? expiresAt.toISOString() : null,
                        is_active: true,
                        device_id: currentHWID
                    })
                    .eq('id', data.id);

                if (updateError) throw updateError;

                localStorage.setItem('zapelite_license_key', key);
                showToast("ZapElite Ativado com HWID Lock!", "success");

                // Reinicia para carregar o software com a nova licen√ßa
                setTimeout(() => {
                    location.reload();
                }, 1500);

            } catch (e) {
                console.error(e);
                showToast("Falha na ativa√ß√£o segura.", "error");
            }
        }
        function generateSecureToken() {
            const chars = 'ABCDEF0123456789';
            let token = '';
            for (let i = 0; i < 32; i++) {
                token += chars.charAt(Math.floor(Math.random() * chars.length));
                if (i === 7 || i === 11 || i === 15 || i === 19) token += '-';
            }
            return token;
        }

        async function createAndConnect(key) {
            const inputId = key === 'user' ? 'name_user' : 'name_partner';
            const rawName = document.getElementById(inputId).value.trim();
            if (!rawName) return showToast("Digite um nome para esta inst√¢ncia!", "error");

            const name = rawName.toLowerCase().replace(/\s+/g, '_');
            const secureToken = generateSecureToken();
            const instObj = key === 'user' ? userInstance : partnerInstance;

            showToast("Gerando Acesso Seguro...", "info");
            document.getElementById(`qr_container_${key}`).innerHTML = '<div style="padding:40px; text-align:center;"><i data-lucide="loader-2" class="spin" style="width:32px; height:32px;"></i><p style="color:#fff; margin-top:10px; opacity:0.7;">Criando Inst√¢ncia Elite...</p></div>';
            lucide.createIcons();

            try {
                const res = await fetch(`${SAAS_CONFIG.baseUrl}/instance/create`, {
                    method: 'POST',
                    headers: { 'apikey': SAAS_CONFIG.globalKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instanceName: name,
                        token: secureToken,
                        qrcode: true,
                        integration: "WHATSAPP-BAILEYS",
                        browser: ["ZapElite", "ZapElite", "1.1.0"]
                    })
                });
                const data = await res.json();

                if (res.status === 201 || data.instance || data.hash) {
                    instObj.name = name;
                    instObj.token = secureToken;

                    localStorage.setItem(`zapelite_${key}_name`, instObj.name);
                    localStorage.setItem(`zapelite_${key}_token`, instObj.token);

                    document.getElementById(`setup_view_${key}`).style.display = 'none';
                    document.getElementById(`qr_view_${key}`).style.display = 'block';
                    document.getElementById(`display_name_${key}`).innerText = instObj.name;

                    setTimeout(() => fetchQRCode(key), 1500);
                    startConnectionPolling(key);
                } else {
                    const errorMsg = data.error || data.message || "Erro na API. Tente outro nome.";
                    showToast(errorMsg, "error");
                }
            } catch (e) {
                console.error("Fetch Error:", e);
                showToast("Sem resposta do servidor.", "error");
            }
        }

        async function fetchQRCode(key) {
            const instObj = key === 'user' ? userInstance : partnerInstance;
            if (instObj.connected) return;

            try {
                const res = await fetch(`${SAAS_CONFIG.baseUrl}/instance/connect/${instObj.name}`, {
                    headers: { 'apikey': instObj.token }
                });
                const data = await res.json();

                if (data.base64) {
                    document.getElementById(`status_badge_${key}`).innerHTML = '<span class="status-badge status-sending pulse">Aguardando Leitura...</span>';
                    document.getElementById(`qr_container_${key}`).innerHTML = `
                        <div class="qr-card-elite">
                            <div class="success-glow"></div>
                            <div class="qr-image-wrapper">
                                <img src="${data.base64}" style="width:200px; height:200px; display:block;">
                            </div>
                            <p style="margin-top:20px; font-size:0.75rem; color:#fff; font-weight:600; text-transform:uppercase; letter-spacing:1px; opacity:0.8;">Aproxime o Celular</p>
                        </div>
                    `;
                } else if (!instObj.connected) {
                    setTimeout(() => fetchQRCode(key), 3000);
                }
            } catch (e) {
                setTimeout(() => fetchQRCode(key), 5000);
            }
        }

        const pollIntervals = { user: null, partner: null };
        function startConnectionPolling(key) {
            if (pollIntervals[key]) clearInterval(pollIntervals[key]);
            pollIntervals[key] = setInterval(() => checkInstanceStatus(key), 4000);
        }

        async function checkInstanceStatus(key) {
            const instObj = key === 'user' ? userInstance : partnerInstance;
            if (!instObj.name) return;
            try {
                const res = await fetch(`${SAAS_CONFIG.baseUrl}/instance/connectionState/${instObj.name}`, {
                    headers: { 'apikey': instObj.token }
                });
                const data = await res.json();

                if (data.instance && data.instance.state === 'open') {
                    instObj.connected = true;
                    updateDashboardStatus();

                    document.getElementById(`status_badge_${key}`).innerHTML = '<span class="status-badge status-sent">ZapElite Ativado</span>';
                    document.getElementById(`qr_container_${key}`).innerHTML = `
                        <div class="qr-card-elite" style="padding: 40px 50px;">
                            <div class="success-glow" style="background:#1ed760; opacity:0.6;"></div>
                            <div style="position:relative; z-index:1;">
                                <i data-lucide="check-circle" style="width:70px; height:70px; color:#1ed760;"></i>
                                <h3 class="elite-gradient-text" style="margin-top:20px; font-size: 1.6rem;">SISTEMA ATIVO</h3>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                    clearInterval(pollIntervals[key]);
                    showToast(`WhatsApp ${key === 'user' ? '01' : '02'} pareado!`, "success");
                }
            } catch (e) { }
        }

        function logoutInstance(key) {
            const instObj = key === 'user' ? userInstance : partnerInstance;
            const modal = document.getElementById('confirmModal');
            document.getElementById('modalTitle').innerText = "Desconectar Conta?";
            document.getElementById('modalMessage').innerText = `Isso remover√° a conex√£o do WhatsApp ${key === 'user' ? '01' : '02'} permanentemente.`;
            modal.classList.add('active');
            lucide.createIcons();

            document.getElementById('modalConfirmBtn').onclick = async () => {
                showToast("Iniciando desconex√£o segura...", "info");
                const cleanBase = SAAS_CONFIG.baseUrl.endsWith('/') ? SAAS_CONFIG.baseUrl.slice(0, -1) : SAAS_CONFIG.baseUrl;
                const instance = instObj.name;

                try {
                    await fetch(`${cleanBase}/instance/delete/${instance}`, {
                        method: 'DELETE',
                        headers: { 'apikey': SAAS_CONFIG.globalKey }
                    });
                } catch (e) { }

                localStorage.removeItem(`zapelite_${key}_name`);
                localStorage.removeItem(`zapelite_${key}_token`);
                location.reload();
            };
        }

        function selectDelayMode(mode) {
            const isFixed = (mode === 'fixed');
            document.getElementById('modeFixed').checked = isFixed;
            document.getElementById('modeRandom').checked = !isFixed;
            document.getElementById('sectionFixedDelay').style.display = isFixed ? 'block' : 'none';
            document.getElementById('sectionRandomDelay').style.display = isFixed ? 'none' : 'block';

            document.getElementById('fixedDelayOption').classList.toggle('active', isFixed);
            document.getElementById('randomDelayOption').classList.toggle('active', !isFixed);

            // Atualizar cores dos √≠cones
            const fixedIcon = document.querySelector('#fixedDelayOption i');
            const randomIcon = document.querySelector('#randomDelayOption i');
            if (fixedIcon) fixedIcon.style.color = isFixed ? 'var(--primary)' : 'var(--text-muted)';
            if (randomIcon) randomIcon.style.color = isFixed ? 'var(--text-muted)' : 'var(--primary)';

            localStorage.setItem('zapelite_delay_mode', mode);
        }

        window.addEventListener('load', () => {
            checkLicenseStatus();

            // Restaurar modo de delay
            const savedDelayMode = localStorage.getItem('zapelite_delay_mode') || 'random';
            selectDelayMode(savedDelayMode);

            const savedFixedInterval = localStorage.getItem('zapelite_fixed_interval');
            if (savedFixedInterval) {
                document.getElementById('fixedInterval').value = savedFixedInterval;
                document.getElementById('fixedDelayValueDisplay').innerText = savedFixedInterval + 's';
            }

            const savedRandomInterval = localStorage.getItem('zapelite_random_interval');
            if (savedRandomInterval) {
                document.getElementById('randomInterval').value = savedRandomInterval;
                document.getElementById('randomDelayValueDisplay').innerText = savedRandomInterval + 's';
            }

            // Restaurar Configura√ß√µes do Disparador
            const savedUseAI = localStorage.getItem('zapelite_use_ai');
            if (savedUseAI !== null) document.getElementById('useAI').checked = (savedUseAI === 'true');

            const savedTestMode = localStorage.getItem('zapelite_test_mode');
            if (savedTestMode !== null) {
                const isTest = (savedTestMode === 'true');
                document.getElementById('testMode').checked = isTest;
                document.getElementById('testModeSettings').style.display = isTest ? 'block' : 'none';
            }

            const savedTestPhone = localStorage.getItem('zapelite_test_phone');
            if (savedTestPhone) document.getElementById('testPhoneNumber').value = savedTestPhone;

            const savedExtraDelay = localStorage.getItem('zapelite_extra_delay');
            if (savedExtraDelay) {
                document.getElementById('extraDelay').value = savedExtraDelay;
                document.getElementById('extraDelayValueDisplay').innerText = savedExtraDelay + 's';
            }

            // Restore Instances
            if (userInstance.name && userInstance.token) {
                document.getElementById('setup_view_user').style.display = 'none';
                document.getElementById('qr_view_user').style.display = 'block';
                document.getElementById('display_name_user').innerText = userInstance.name;
                startConnectionPolling('user');
            }
            if (partnerInstance.name && partnerInstance.token) {
                document.getElementById('setup_view_partner').style.display = 'none';
                document.getElementById('qr_view_partner').style.display = 'block';
                document.getElementById('display_name_partner').innerText = partnerInstance.name;
                startConnectionPolling('partner');
            }

            // Carregar e limpar logs antigos (5h de validade)
            loadAndCleanLogs();
        });

        // Salvar configura√ß√µes automaticamente ao alterar
        document.getElementById('fixedInterval').addEventListener('input', (e) => localStorage.setItem('zapelite_fixed_interval', e.target.value));
        document.getElementById('randomInterval').addEventListener('input', (e) => localStorage.setItem('zapelite_random_interval', e.target.value));
        document.getElementById('useAI').addEventListener('change', (e) => localStorage.setItem('zapelite_use_ai', e.target.checked));
        document.getElementById('testMode').addEventListener('change', (e) => {
            localStorage.setItem('zapelite_test_mode', e.target.checked);
            document.getElementById('testModeSettings').style.display = e.target.checked ? 'block' : 'none';
        });
        document.getElementById('testPhoneNumber').addEventListener('input', (e) => localStorage.setItem('zapelite_test_phone', e.target.value));
        document.getElementById('extraDelay').addEventListener('input', (e) => localStorage.setItem('zapelite_extra_delay', e.target.value));


        // --- CORE LOGIC ---
        let contacts = [];
        let isRunning = false;
        let isPaused = false;
        let stopRequested = false;
        let attachedMediaList = [];

        function saveLogToStorage(logData) {
            try {
                const logs = JSON.parse(localStorage.getItem('zapelite_persistent_logs') || '[]');
                logs.push({ ...logData, timestamp: Date.now() });
                localStorage.setItem('zapelite_persistent_logs', JSON.stringify(logs));
            } catch (e) { console.error("Erro ao salvar log:", e); }
        }

        function loadAndCleanLogs() {
            try {
                let logs = JSON.parse(localStorage.getItem('zapelite_persistent_logs') || '[]');
                const fiveHoursAgo = Date.now() - (5 * 60 * 60 * 1000);

                // Filtra logs dos √∫ltimos 5 horas
                logs = logs.filter(log => log.timestamp > fiveHoursAgo);
                localStorage.setItem('zapelite_persistent_logs', JSON.stringify(logs));

                // Renderiza na tabela
                const b = document.getElementById('logBody');
                if (b) {
                    b.innerHTML = '';
                    logs.forEach(log => {
                        const r = document.createElement('tr');
                        r.id = log.id;
                        r.innerHTML = `
                            <td><strong>${log.displayName}</strong></td>
                            <td><span style="opacity:0.6; font-size:0.7rem;">${log.campName}</span></td>
                            <td><span class="status-badge ${log.cls}">${log.status}</span></td>
                            <td>${new Date(log.timestamp).toLocaleTimeString()}</td>
                            <td style='color:var(--text-muted); font-size:0.75rem'>
                                ${(log.msg || "").substring(0, 30)}...
                                <button onclick="showLogPreview('${log.id}')" style="background:none; border:none; color:var(--primary); cursor:pointer; font-size:0.65rem; padding:0; margin-left:5px; text-decoration:underline;">[ver]</button>
                                <div id="msg-${log.id}" style="display:none;">${log.msg}</div>
                            </td>
                        `;
                        b.prepend(r);
                    });
                }
            } catch (e) { console.error("Erro ao carregar logs:", e); }
        }

        function closeModal() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            let icon = 'check-circle';
            if (type === 'error') icon = 'alert-circle';
            if (type === 'info') icon = 'info';

            toast.innerHTML = `<i data-lucide="${icon}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => toast.classList.add('show'), 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 3500);
        }

        const mediaInputs = ['mediaImage', 'mediaAudio', 'mediaVideo', 'mediaFile'];
        mediaInputs.forEach(id => {
            document.getElementById(id).addEventListener('change', async (e) => {
                if (e.target.files[0]) {
                    const file = e.target.files[0];
                    showToast(`Carregando ${file.name}...`, 'info');
                    const base64 = await fileToBase64(file);
                    attachedMediaList.push({
                        id: 'm-' + Date.now(),
                        name: file.name,
                        type: id.replace('media', '').toLowerCase(),
                        mimetype: file.type,
                        base64: base64.split(',')[1]
                    });
                    renderMediaList();
                }
            });
        });

        // --- Elite Wizard / Stepper Logic ---
        let currentWizardStep = 1;
        function goToWizardStep(step) {
            // Validate step transitions if needed
            if (step > currentWizardStep) {
                if (currentWizardStep === 1) {
                    const name = document.getElementById('campaignName').value.trim();
                    if (!name) {
                        showToast("D√™ um nome para sua campanha!", "warning");
                        return;
                    }
                }
            }

            // Update UI
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            document.getElementById(`wizard-step-${step}`).classList.add('active');

            document.querySelectorAll('.step-item').forEach((item, idx) => {
                idx + 1 === step ? item.classList.add('active') : item.classList.remove('active');
                idx + 1 < step ? item.classList.add('completed') : item.classList.remove('completed');
            });

            currentWizardStep = step;
            lucide.createIcons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        let messageBlockCount = 1;
        function addMessageBlock() {
            if (messageBlockCount >= 5) {
                return showToast("M√°ximo de 5 mensagens por disparo!", "warning");
            }
            messageBlockCount++;
            const container = document.getElementById('messagesContainer');
            const block = document.createElement('div');
            block.className = 'msg-block';
            block.id = `msg-block-${messageBlockCount}`;
            block.innerHTML = `
                <div class="msg-block-header">
                    <span style="font-size: 0.75rem; font-weight: 800; color: var(--primary);">MENSAGEM #${messageBlockCount}</span>
                    <button class="remove-msg-btn" onclick="removeMessageBlock('${block.id}')">
                        <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                    </button>
                </div>
                <textarea class="campaign-message" rows="4" placeholder="Escreva sua pr√≥xima mensagem..."></textarea>
            `;
            container.appendChild(block);
            lucide.createIcons();
        }

        function removeMessageBlock(id) {
            const block = document.getElementById(id);
            if (block) {
                block.remove();
                messageBlockCount--;
                // Renumber blocks
                document.querySelectorAll('.msg-block').forEach((b, idx) => {
                    b.querySelector('.msg-block-header span').innerText = `MENSAGEM #${idx + 1}`;
                });
            }
        }

        function insertTag(tag) {
            // Find the last focused textarea or the first one
            const areas = document.querySelectorAll('.campaign-message');
            let area = document.activeElement;
            if (!area || !area.classList.contains('campaign-message')) {
                area = areas[0];
            }

            const start = area.selectionStart;
            const end = area.selectionEnd;
            const text = area.value;
            area.value = text.substring(0, start) + tag + text.substring(end);
            area.focus();
            area.selectionStart = area.selectionEnd = start + tag.length;
        }

        let currentLeadSource = 'csv';
        function setLeadSource(source) {
            currentLeadSource = source;
            document.querySelectorAll('.source-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.source-content').forEach(c => c.style.display = 'none');

            // Mapeamento correto para os IDs do HTML
            let suffix = source.charAt(0).toUpperCase() + source.slice(1);
            if (source === 'xlsx') suffix = 'XLSX';
            if (source === 'csv') suffix = 'CSV';

            const tab = document.getElementById('tabSource' + suffix);
            const content = document.getElementById('source' + suffix);

            if (tab) tab.classList.add('active');
            if (content) content.style.display = 'block';

            contacts = [];
            document.getElementById('contactsCount').innerText = 'Fila limpa. Aguardando novos contatos...';
        }

        function processManualLeads() {
            const raw = document.getElementById('manualLeads').value.trim();
            if (!raw) return showToast("Insira ao menos um n√∫mero!", "error");

            const lines = raw.split('\n');
            contacts = lines.map(line => {
                const parts = line.split(/[;,]/); // Suporta v√≠rgula ou ponto-e-v√≠rgula
                let name = "Membro";
                let phone = "";
                let company = "";

                if (parts.length === 1) {
                    phone = parts[0].trim();
                } else {
                    // Smart detection: Qual parte parece um n√∫mero?
                    const p1 = parts[0].trim();
                    const p2 = parts[1].trim();
                    const p1Digits = p1.replace(/\D/g, '');
                    const p2Digits = p2.replace(/\D/g, '');

                    if (p2Digits.length >= 8 && p2Digits.length > p1Digits.length) {
                        name = p1;
                        phone = p2;
                    } else {
                        name = p2;
                        phone = p1;
                    }
                    company = parts[2] ? parts[2].trim() : "";
                }

                let p = phone.replace(/\D/g, '');
                if (p.length === 10 || p.length === 11) p = '55' + p;

                return p ? { name, phone: p, company } : null;
            }).filter(x => x);

            document.getElementById('contactsCount').innerText = `${contacts.length} contatos carregados manualmente`;
            showToast(`${contacts.length} contatos prontos!`, "success");
        }

        async function loadGroupsForSender() {
            const selectedKey = document.getElementById('instanceSelector').value;
            const instObj = selectedKey === 'user' ? userInstance : partnerInstance;

            if (!instObj.connected) return showToast(`Conecte o WhatsApp ${selectedKey === 'user' ? '01' : '02'} primeiro!`, "error");
            showToast("Buscando grupos...", "info");

            const instance = instObj.name;
            const token = instObj.token;
            const base = SAAS_CONFIG.baseUrl.replace(/\/+$/, '');

            // Tenta as mesmas rotas da extra√ß√£o principal
            const routes = [
                { url: `${base}/group/fetchAllGroups/${instance}?getParticipants=false` },
                { url: `${base}/group/fetchAllGroups/${instance}` },
                { url: `${base}/chat/getChats/${instance}` },
                { url: `${base}/group/fetchAll/${instance}` }
            ];

            let success = false;
            for (const test of routes) {
                try {
                    const res = await fetchWithTimeout(test.url, { headers: { 'apikey': token } }, 20000);
                    if (res.ok) {
                        const data = await res.json();
                        let groups = Array.isArray(data) ? data : (data.groups || data.chats || data.instances || data.data || []);

                        if (test.url.includes('/chat/')) {
                            groups = groups.filter(c => c.id?.endsWith('@g.us') || c.jid?.endsWith('@g.us'));
                        }

                        if (Array.isArray(groups) && groups.length > 0) {
                            const select = document.getElementById('groupsSelectSender');
                            select.innerHTML = '<option value="">Selecione um grupo...</option>';
                            groups.forEach(g => {
                                const opt = document.createElement('option');
                                opt.value = g.id || g.jid || (g.id && g.id._serialized) || "";
                                opt.innerText = g.subject || g.name || opt.value;
                                select.appendChild(opt);
                            });
                            showToast(`${groups.length} grupos carregados!`, "success");
                            success = true;
                            break;
                        }
                    }
                } catch (e) {
                    console.error("Erro na busca de grupos:", test.url, e);
                }
            }

            if (!success) {
                showToast("Erro ao buscar grupos. Tente novamente.", "error");
            }

            document.getElementById('groupsSelectSender').onchange = async (e) => {
                const gid = e.target.value;
                const gname = e.target.options[e.target.selectedIndex].text;
                if (!gid) return;

                showToast("Buscando membros do grupo...", "info");
                const memberRoutes = [
                    `${base}/group/findGroupInfos/${instance}?groupJid=${gid}`,
                    `${base}/group/getParticipants/${instance}?groupJid=${gid}`,
                    `${base}/group/participants/${instance}?groupJid=${gid}`,
                    `${base}/group/members/${instance}/${gid}`
                ];

                let membersSuccess = false;
                for (const mRoute of memberRoutes) {
                    try {
                        const res = await fetchWithTimeout(mRoute, { headers: { 'apikey': token } });
                        if (res.ok) {
                            const data = await res.json();
                            let members = Array.isArray(data) ? data : (data.participants || data.members || (data.groupInfo ? data.groupInfo.participants : null) || (data.data ? (data.data.participants || data.data) : []));

                            if (Array.isArray(members) && members.length > 0) {
                                contacts = members.map(m => {
                                    let phone = "";
                                    let name = m.name || m.pushName || m.notify || m.verifiedName || "Membro";

                                    let phoneNumber = m.phoneNumber || m.number || m.senderPn || (m.id && m.id.user ? m.id.user : "");
                                    let jid = m.jid || (m.id && typeof m.id === 'string' ? m.id : (m.id && m.id._serialized ? m.id._serialized : ""));

                                    if (jid.includes('@s.whatsapp.net')) {
                                        phone = jid.split('@')[0].split(':')[0].replace(/\D/g, '');
                                    } else if (jid.includes('@lid') || jid.includes('@l.io')) {
                                        phone = jid;
                                    } else if (phoneNumber) {
                                        phone = phoneNumber.toString().replace(/\D/g, '');
                                    }

                                    if (phone && (phone.length === 10 || phone.length === 11)) phone = '55' + phone;
                                    return phone ? { name, phone, company: gname } : null;
                                }).filter(x => x);

                                document.getElementById('contactsCount').innerText = `${contacts.length} membros carregados para envio`;
                                showToast("Membros carregados!", "success");
                                membersSuccess = true;
                                break;
                            }
                        }
                    } catch (e) { }
                }

                if (!membersSuccess) showToast("Erro ao carregar membros do grupo.", "error");
            };
        }

        function requestCampaignConfirmation() {
            const isTest = document.getElementById('testMode').checked;
            const messages = Array.from(document.querySelectorAll('.campaign-message')).map(t => t.value.trim()).filter(v => v);

            if (!isTest && contacts.length === 0) return showToast("Carregue contatos primeiro!", "error");
            if (messages.length === 0) return showToast("Escreva ao menos uma mensagem!", "error");

            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            const isScheduled = date && time;

            const campName = document.getElementById('campaignName').value.trim() || "Nova Campanha";
            const selectedKey = document.getElementById('instanceSelector').value;
            const instLabel = selectedKey === 'user' ? 'WhatsApp 01' : 'WhatsApp 02';

            const useAI = document.getElementById('useAI').checked;
            const delayMode = localStorage.getItem('zapelite_delay_mode') || 'random';
            const extraWait = parseInt(document.getElementById('extraDelay').value) || 0;
            const smartVal = parseInt(document.getElementById('randomInterval').value) || 15;
            const fixedVal = parseInt(document.getElementById('fixedInterval').value) || 10;

            let baseDelay = (delayMode === 'fixed') ? fixedVal : smartVal;
            let totalDelay = baseDelay + extraWait;

            let delayDesc = "";
            if (delayMode === 'fixed') {
                delayDesc = `Fixo (${fixedVal}s)`;
            } else {
                delayDesc = `Inteligente (at√© ${smartVal}s)`;
            }
            if (extraWait > 0) delayDesc += ` + ${extraWait}s extra`;

            let html = `
                <div style="background: rgba(30, 215, 96, 0.1); padding: 15px; border-radius: 12px; border: 1px solid var(--primary); margin-bottom: 20px;">
                    <h4 style="color: var(--primary); margin-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">${isTest ? 'üß™ MODO DE TESTE ATIVO' : 'üöÄ RESUMO DA CAMPANHA'}</h4>
                    <p style="font-size: 1.1rem; font-weight: 800; color: #fff;">${isTest ? 'Envio √önico de Valida√ß√£o' : campName}</p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; border: 1px solid var(--border);">
                        <p style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Inst√¢ncia</p>
                        <p style="font-size: 0.9rem; font-weight: 700; color: #fff;">${instLabel}</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; border: 1px solid var(--border);">
                        <p style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Contatos</p>
                        <p style="font-size: 0.9rem; font-weight: 700; color: #fff;">${isTest ? '1 (Teste)' : contacts.length}</p>
                    </div>
                    <div style="background: rgba(30, 215, 96, 0.05); padding: 12px; border-radius: 10px; border: 1px solid var(--primary);">
                        <p style="font-size: 0.7rem; color: var(--primary); text-transform: uppercase; font-weight: 700;">Tempo Estimado/Msg</p>
                        <p style="font-size: 1.1rem; font-weight: 800; color: #fff;">${totalDelay}s</p>
                        <p style="font-size: 0.6rem; color: var(--text-muted); margin-top: 4px;">Soma do Delay + Extra</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; border: 1px solid var(--border);">
                        <p style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">IA Anti-Ban</p>
                        <p style="font-size: 0.85rem; font-weight: 700; color: ${useAI ? 'var(--primary)' : '#ff4444'};">${useAI ? 'ATIVADO' : 'DESATIVADO'}</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; border: 1px solid var(--border);">
                        <p style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Agendamento</p>
                        <p style="font-size: 0.85rem; font-weight: 700; color: #fff;">${isScheduled ? `${date} √†s ${time}` : 'Imediato'}</p>
                    </div>
                </div>

                <div style="background: rgba(255, 243, 205, 0.05); padding: 12px; border-radius: 10px; border: 1px solid rgba(245, 166, 35, 0.3); margin-bottom: 20px;">
                    <p style="font-size: 0.75rem; color: #f5a623; line-height: 1.4;">
                        <i data-lucide="info" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 5px;"></i>
                        <strong>Seguran√ßa Anti-Ban:</strong> O intervalo total de <strong>${totalDelay} segundos</strong> entre mensagens simula o comportamento humano, protegendo seu chip contra bloqueios do WhatsApp.
                    </p>
                </div>

                <div style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 12px; border: 1px solid var(--border);">
                    <p style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px;">Pr√©via do Conte√∫do</p>
                    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.8); line-height: 1.5; font-style: italic;">
                        "${messages[0].substring(0, 150)}${messages[0].length > 150 ? '...' : ''}"
                    </p>
                    ${messages.length > 1 ? `<p style="margin-top: 5px; font-size: 0.75rem; color: var(--secondary);">+ ${messages.length - 1} bal√£o(√µes) de mensagem sequencial</p>` : ''}
                    ${attachedMediaList.length > 0 ? `<p style="margin-top: 10px; font-size: 0.75rem; color: var(--primary); font-weight: 700;">üìé + ${attachedMediaList.length} anexo(s) de m√≠dia</p>` : ''}
                </div>
            `;
            document.getElementById('confirmDetails').innerHTML = html;
            document.getElementById('confirmOverlay').classList.add('active');
            lucide.createIcons();
        }

        function closeConfirmModal() {
            document.getElementById('confirmOverlay').classList.remove('active');
        }

        async function confirmCampaign() {
            closeConfirmModal();
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            const campName = document.getElementById('campaignName').value.trim() || "Nova Campanha";

            if (date && time) {
                const targetDate = new Date(`${date}T${time}`);
                const now = new Date();
                const diff = targetDate - now;

                if (diff > 0) {
                    showToast(`Campanha agendada para ${date} √†s ${time}`, "info");

                    // Adiciona log de agendamento para visibilidade
                    addLog("-", "Agendado", "status-warning", `Envio programado para ${date} √†s ${time}. O software deve permanecer aberto.`, undefined, campName);

                    document.getElementById('progressStatus').innerText = "Aguardando hor√°rio agendado...";
                    document.getElementById('startBtn').disabled = true;

                    // Salva no localStorage para persist√™ncia (LoadAndCleanLogs ir√° mostrar)
                    setTimeout(() => startSending(), diff);
                    return;
                }
            }
            startSending();
        }

        function renderMediaList() {
            const container = document.getElementById('mediaPreviewList');
            container.innerHTML = '';
            attachedMediaList.forEach(m => {
                const div = document.createElement('div');
                div.style = "background: rgba(30, 215, 96, 0.05); padding: 12px 18px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border);";
                div.innerHTML = `
                    <span style='font-size:0.9rem; display: flex; align-items: center; gap: 10px;'>
                        <i data-lucide='check' style='width:16px; height:16px; color:var(--primary)'></i> 
                        ${m.name}
                    </span> 
                    <span style='color:var(--danger); cursor:pointer; display: flex; align-items: center;' onclick='removeMedia("${m.id}")'>
                        <i data-lucide='trash-2' style='width:18px; height:18px;'></i>
                    </span>`;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function removeMedia(id) {
            attachedMediaList = attachedMediaList.filter(m => m.id !== id);
            renderMediaList();
        }

        document.getElementById('contactsFile').addEventListener('change', async e => {
            if (!e.target.files[0]) return;
            const file = e.target.files[0];
            const reader = new FileReader();

            showToast(`Lendo planilha ${file.name}...`, 'info');

            if (file.name.endsWith('.csv')) {
                reader.onload = function (evt) {
                    processContactData(evt.target.result);
                };
                reader.readAsText(file);
            } else {
                reader.onload = function (evt) {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // Converter array de arrays para string simulando CSV para o processador
                    const simulatedCsv = json.map(row => row.join(',')).join('\n');
                    processContactData(simulatedCsv);
                };
                reader.readAsArrayBuffer(file);
            }
        });

        function processContactData(csvText) {
            const lines = csvText.split(/\r?\n/);
            contacts = lines.map(line => {
                let text = line.trim();
                if (!text) return null;

                let name = "Membro";
                let phone = "";
                let company = "";

                const parts = text.split(/[;,]/);
                if (parts.length === 1) {
                    phone = parts[0].trim();
                } else {
                    const p1 = parts[0].trim();
                    const p2 = parts[1].trim();
                    const p1D = p1.replace(/\D/g, '');
                    const p2D = p2.replace(/\D/g, '');

                    if (p2D.length >= 8 && p2D.length > p1D.length) {
                        name = p1; phone = p2;
                    } else {
                        name = p2; phone = p1;
                    }
                    company = parts[2] ? parts[2].trim() : "";
                }

                let p = phone.trim();
                if (p.includes('@')) {
                    // Mant√©m JID/LID intacto
                } else {
                    p = p.replace(/\D/g, '');
                    if (p.length === 10 || p.length === 11) p = '55' + p;
                }

                return p ? { name, phone: p, company } : null;
            }).filter(x => x);

            document.getElementById('contactsCount').innerText = `${contacts.length} destinat√°rios carregados`;
            showToast(`${contacts.length} contatos prontos!`, "success");
        }

        async function startSending() {
            if (!userInstance.connected) {
                showToast("Conecte seu WhatsApp primeiro nas Configura√ß√µes!", "error");
                showTab('settings');
                return;
            }

            const messages = Array.from(document.querySelectorAll('.campaign-message')).map(t => t.value.trim()).filter(v => v);
            if (messages.length === 0) return showToast("Escreva ao menos uma mensagem!", "error");

            isRunning = true;
            stopRequested = false;
            isPaused = false;

            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('pauseBtn').style.display = 'flex';
            document.getElementById('pauseBtn').innerHTML = '<i data-lucide="pause"></i> Pausar';
            // N√£o limpamos mais o logBody para manter o hist√≥rico e agendamentos vis√≠veis
            lucide.createIcons();

            const isTestMode = document.getElementById('testMode').checked;
            const testPhone = document.getElementById('testPhoneNumber').value.trim();
            const campName = document.getElementById('campaignName').value.trim() || "Nova Campanha";
            const selectedKey = document.getElementById('instanceSelector').value;
            const instObj = selectedKey === 'user' ? userInstance : partnerInstance;

            if (!instObj.connected) {
                showToast(`Conecte o WhatsApp ${selectedKey === 'user' ? '01' : '02'} antes!`, "error");
                stopSending();
                return;
            }

            let targets = isTestMode ?
                [{ name: "Teste de Valida√ß√£o", phone: testPhone.replace(/\D/g, ''), company: "SISTEMA" }] :
                contacts;

            if (isTestMode && !testPhone) {
                showToast("Insira o n√∫mero de teste!", "error");
                isRunning = false; return stopSending();
            }

            const delayMode = localStorage.getItem('zapelite_delay_mode') || 'random';
            const fixedVal = parseInt(document.getElementById('fixedInterval').value) || 15;
            const randomVal = parseInt(document.getElementById('randomInterval').value) || 20;
            const balloonWait = parseInt(document.getElementById('extraDelay').value) || 3;

            for (let i = 0; i < targets.length; i++) {
                if (stopRequested) break;
                while (isPaused && !stopRequested) await new Promise(r => setTimeout(r, 1000));

                const contact = targets[i];
                updateProgress(i + 1, targets.length, contact.phone);

                // LOOP DE BAL√ïES (MENSAGENS SEQUENCIAIS)
                for (let mIdx = 0; mIdx < messages.length; mIdx++) {
                    if (stopRequested) break;

                    let msg = messages[mIdx];

                    // Personaliza√ß√£o
                    const now = new Date();
                    const hours = now.getHours();
                    const saudacao = hours < 12 ? "Bom dia" : hours < 18 ? "Boa tarde" : "Boa noite";
                    const diaSemana = ["domingo", "segunda-feira", "ter√ßa-feira", "quarta-feira", "quinta-feira", "sexta-feira", "s√°bado"][now.getDay()];
                    const firstName = contact.name.split(' ')[0] || "amigo(a)";

                    msg = msg.replace(/{{saudacao}}/gi, saudacao)
                        .replace(/{{nome}}/gi, firstName)
                        .replace(/{{dia_semana}}/gi, diaSemana)
                        .replace(/{{hora}}/gi, now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));

                    const logId = addLog(contact.name || contact.phone, `Bal√£o ${mIdx + 1}`, 'status-sending', msg, i + 1, campName);

                    try {
                        const config = { baseUrl: SAAS_CONFIG.baseUrl, token: instObj.token, instance: instObj.name };
                        const isSuccess = (res) => res && (res.key || res.status === 'SUCCESS' || res.status === 200 || res.instance || res.message === 'SUCCESS');

                        let res = await sendEvolution(contact.phone, msg, config, null);

                        if (isSuccess(res)) {
                            updateLogStatus(logId, 'Entregue', 'status-sent');

                            // M√≠dias apenas no primeiro bal√£o
                            if (mIdx === 0 && attachedMediaList.length > 0) {
                                for (const media of attachedMediaList) {
                                    await new Promise(r => setTimeout(r, 2000));
                                    await sendEvolution(contact.phone, '', config, media);
                                }
                            }

                            // Delay entre bal√µes se houver mais um vindo
                            if (mIdx < messages.length - 1) {
                                updateProgress(i + 1, targets.length, `${contact.phone} (Espere: Bal√£o ${mIdx + 2})`);
                                await new Promise(r => setTimeout(r, balloonWait * 1000));
                            }
                        } else {
                            updateLogStatus(logId, 'Falha', 'status-danger');
                        }
                    } catch (e) {
                        updateLogStatus(logId, 'Erro', 'status-danger');
                    }
                }

                // Delay entre contatos
                if (i < targets.length - 1 && !stopRequested) {
                    let delay = (delayMode === 'fixed') ? fixedVal : (Math.floor(Math.random() * (randomVal - 10)) + 10);
                    let rem = delay;
                    while (rem > 0 && !stopRequested) {
                        updateProgress(i + 1, targets.length, `Pr√≥ximo em ${rem}s...`);
                        await new Promise(r => setTimeout(r, 1000));
                        rem--;
                        while (isPaused && !stopRequested) await new Promise(r => setTimeout(r, 1000));
                    }
                }
            }

            if (isTestMode && !stopRequested) {
                showToast("Teste enviado com sucesso!", "success");
            }

            isRunning = false; stopSending();
        }

        function stopSending() {
            stopRequested = true;
            isPaused = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function togglePause() {
            if (!isRunning) return;
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            if (isPaused) {
                btn.innerHTML = '<i data-lucide="play"></i> Continuar';
                btn.style.background = 'var(--primary)';
                btn.style.borderColor = 'var(--primary)';
                showToast("Campanha Pausada", "info");
            } else {
                btn.innerHTML = '<i data-lucide="pause"></i> Pausar';
                btn.style.background = '#f5a623';
                btn.style.borderColor = '#f5a623';
                showToast("Campanha Retomada", "success");
            }
            lucide.createIcons();
        }

        async function getAIContent(prompt, key) {
            console.log("[IA] Gerando varia√ß√£o de conte√∫do...");
            try {
                const res = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [{ role: "system", content: "Voc√™ √© um assistente de marketing. Reescreva a mensagem do usu√°rio mantendo o sentido, mas variando as palavras para evitar detec√ß√£o de spam. Seja breve." }, { role: "user", content: prompt }],
                        temperature: 0.8
                    })
                });
                const data = await res.json();
                const aiMsg = data.choices[0].message.content;
                console.log("[IA] Conte√∫do gerado com sucesso.");
                return aiMsg;
            } catch (e) {
                console.error("[IA] Erro ao gerar conte√∫do:", e);
                return prompt;
            }
        }

        const { ipcRenderer, shell } = require('electron');

        ipcRenderer.on('update_available', (event, info) => {
            console.log("Update Available:", info);
            showToast(`Nova vers√£o v${info.version} dispon√≠vel! Baixando em segundo plano...`, "info");

            document.getElementById('update_version_text').innerText = `Vers√£o ${info.version} dispon√≠vel`;
            const notesList = document.getElementById('notes_list');
            notesList.innerHTML = info.releaseNotes || "<li>Melhorias gerais e corre√ß√µes de bugs.</li>";

            // Se a atualiza√ß√£o contiver [REQUIRED], for√ßamos a abertura do modal
            if (info.releaseNotes && info.releaseNotes.includes('[REQUIRED]')) {
                document.getElementById('skip_update_btn').style.display = 'none';
                document.getElementById('updateModal').classList.add('active');
            }

            // Inicia o download automaticamente
            startSoftwareUpdate();
        });

        ipcRenderer.on('download_progress', (event, progressObj) => {
            const p = Math.round(progressObj.percent);
            const bar = document.getElementById('update_progress_bar');
            if (bar) bar.style.width = p + '%';

            // Se o usu√°rio abriu o modal, ele ver√° o progresso
            document.getElementById('update_progress_container').style.display = 'block';
            document.getElementById('update_actions').style.display = 'none';
        });

        ipcRenderer.on('update_downloaded', () => {
            showToast("Atualiza√ß√£o baixada! O sistema ir√° reiniciar em breve...", "success");

            // Aguarda 5 segundos para o usu√°rio ler, ou reinicia imediatamente se n√£o estiver enviando
            setTimeout(() => {
                if (!isRunning) {
                    ipcRenderer.send('restart_app');
                } else {
                    showToast("Download conclu√≠do! O ZapElite reiniciar√° assim que os envios atuais terminarem.", "info");
                    // Monitora o fim do processo de envio para reiniciar
                    const autoRestartInterval = setInterval(() => {
                        if (!isRunning) {
                            clearInterval(autoRestartInterval);
                            ipcRenderer.send('restart_app');
                        }
                    }, 5000);
                }
            }, 5000);
        });

        function closeUpdateModal() {
            document.getElementById('updateModal').classList.remove('active');
        }

        function startSoftwareUpdate() {
            // Notificamos o processo principal para iniciar o download (caso n√£o seja autom√°tico)
            ipcRenderer.send('start_download');

            document.getElementById('update_actions').style.display = 'none';
            document.getElementById('update_progress_container').style.display = 'block';
        }

        function checkForUpdatesManually() {
            showToast("Verificando se h√° atualiza√ß√µes...", "info");
            ipcRenderer.send('check_for_updates');
        }

        async function sendEvolution(phone, text, config, media) {
            let type = media ? 'sendMedia' : 'sendText';
            if (media && media.type === 'audio') type = 'sendWhatsAppAudio';

            const url = `${config.baseUrl}/message/${type}/${config.instance}`;

            let body = { number: phone };

            if (media) {
                if (media.type === 'audio') {
                    body.audio = media.base64;
                    body.ptt = true;
                } else {
                    body.media = media.base64;
                    body.mediatype = (media.type === 'file') ? 'document' : media.type;
                    body.mimetype = media.mimetype;
                    body.caption = text || "";
                    body.fileName = media.name;
                }
            } else {
                body.text = text;
            }

            const r = await fetch(url, {
                method: 'POST',
                headers: { 'apikey': config.token, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            return await r.json();
        }

        function formatPhoneForDisplay(p) {
            if (!p) return "";
            if (p.includes('@')) {
                const digits = p.split('@')[0];
                return `‚úÖ ID: ${digits.substring(0, 4)}...${digits.slice(-4)}`;
            }
            return p;
        }

        function updateProgress(curr, tot, lead) {
            const p = Math.round((curr / tot) * 100);
            document.getElementById('progressBar').style.width = p + '%';
            document.getElementById('progressPercent').innerText = p + '%';
            document.getElementById('progressDetailed').innerText = `Disparando contato ${curr} de ${tot}`;
        }

        function addLog(name, status, cls, msg, index, campaign) {
            const b = document.getElementById('logBody');
            const r = document.createElement('tr');
            const id = 'log-' + Math.random().toString(36).substr(2, 9);
            r.id = id;

            let displayName = "";
            if (index !== undefined) {
                if (name && !name.includes('@') && isNaN(name)) displayName = `‚úÖ ID: ${index} - ${name}`;
                else displayName = `‚úÖ ID: ${index}`;
            } else {
                displayName = name.includes('@') ? formatPhoneForDisplay(name) : name;
            }

            const campName = campaign || "Disparo Simples";

            r.innerHTML = `
                <td><strong>${displayName}</strong></td>
                <td><span style="opacity:0.6; font-size:0.7rem;">${campName}</span></td>
                <td><span class="status-badge ${cls}">${status}</span></td>
                <td>${new Date().toLocaleTimeString()}</td>
                <td style='color:var(--text-muted); font-size:0.75rem'>
                    ${(msg || "").substring(0, 30)}...
                    <button onclick="showLogPreview('${id}')" style="background:none; border:none; color:var(--primary); cursor:pointer; font-size:0.65rem; padding:0; margin-left:5px; text-decoration:underline;">[ver]</button>
                    <div id="msg-${id}" style="display:none;">${msg}</div>
                </td>
            `;
            b.prepend(r);

            // Persist√™ncia
            saveLogToStorage({ id, displayName, campName, status, cls, msg });

            return id;
        }

        function updateLogStatus(id, status, cls) {
            const r = document.getElementById(id);
            if (r) {
                const s = r.querySelector('.status-badge');
                if (s) {
                    s.className = `status-badge ${cls}`;
                    s.innerText = status;
                }

                // Atualizar armazenamento persistente
                try {
                    let logs = JSON.parse(localStorage.getItem('zapelite_persistent_logs') || '[]');
                    const logIdx = logs.findIndex(l => l.id === id);
                    if (logIdx !== -1) {
                        logs[logIdx].status = status;
                        logs[logIdx].cls = cls;
                        localStorage.setItem('zapelite_persistent_logs', JSON.stringify(logs));
                    }
                } catch (e) { }

                // Atualiza estat√≠sticas do dashboard
                if (status === 'Enviado' || status === 'Entregue') {
                    const s = document.getElementById('stat-success');
                    s.innerText = parseInt(s.innerText) + 1;
                    const t = document.getElementById('stat-total');
                    t.innerText = parseInt(t.innerText) + 1;
                }
            }
        }

        function showLogPreview(id) {
            const div = document.getElementById('msg-' + id);
            if (!div) return showToast("Erro ao recuperar mensagem.", "error");
            const msg = div.innerText;

            showToast("Visualizando conte√∫do enviado...", "info");

            const overlay = document.createElement('div');
            overlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; display:flex; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(5px); transition:all 0.3s ease;";
            overlay.onclick = () => overlay.remove();

            const card = document.createElement('div');
            card.style = "background:var(--bg-card); border:1px solid var(--border); padding:30px; border-radius:24px; max-width:550px; width:100%; position:relative; box-shadow:0 25px 60px rgba(0,0,0,0.6); animation:modalSlide 0.3s ease-out;";
            card.onclick = (e) => e.stopPropagation();

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="display:flex; align-items:center; gap:12px; color:var(--primary); font-size:1.3rem;">
                        <i data-lucide="message-square"></i> Conte√∫do da Mensagem
                    </h3>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i data-lucide="x"></i></button>
                </div>
                <div style="background:rgba(255,255,255,0.03); padding:25px; border-radius:15px; border:1px solid var(--border); color:rgba(255,255,255,0.9); font-size:1rem; line-height:1.6; white-space:pre-wrap; max-height:350px; overflow-y:auto; font-family:'Inter', sans-serif;">${msg}</div>
                <button class="btn btn-primary" style="width:100%; margin-top:25px; height:50px; border-radius:15px;" onclick="this.parentElement.parentElement.remove()">Fechar Visualiza√ß√£o</button>
            `;
            overlay.appendChild(card);
            document.body.appendChild(overlay);
            lucide.createIcons();
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const rd = new FileReader();
                rd.readAsDataURL(file);
                rd.onload = () => resolve(rd.result);
                rd.onerror = e => reject(e);
            });
        }

        // --- EXTRACTOR LOGIC ---
        let lastExtractedContacts = [];

        async function loadWhatsAppGroups() {
            const selectedKey = document.getElementById('extractorInstanceSelector').value;
            const instObj = selectedKey === 'user' ? userInstance : partnerInstance;

            if (!instObj.connected) {
                showToast(`Conecte o WhatsApp ${selectedKey === 'user' ? '01' : '02'} primeiro!`, "error");
                showTab('settings');
                return;
            }

            const container = document.getElementById('groups_container');
            container.innerHTML = `
                <div style="padding: 40px; display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <i data-lucide="loader-2" class="spin"></i> 
                    <span>Extraindo grupos da conta ${selectedKey === 'user' ? '01' : '02'}...</span>
                </div>`;
            lucide.createIcons();

            const instance = instObj.name;
            const token = instObj.token;
            const base = SAAS_CONFIG.baseUrl.replace(/\/+$/, '');
            const cleanBase = base.replace(/\/v1\/?$/, '').replace(/\/v2\/?$/, '');

            // MATRIZ OTIMIZADA: Tenta as rotas mais prov√°veis primeiro com timeout maior
            const tests = [
                { url: `${base}/group/fetchAllGroups/${instance}?getParticipants=false`, type: 'modern' },
                { url: `${base}/group/fetchAllGroups/${instance}`, type: 'modern' },
                { url: `${base}/chat/getChats/${instance}`, type: 'chats' },
                { url: `${base}/group/fetchAll/${instance}`, type: 'legacy' }
            ];

            let success = false;
            let logRelatorio = [];

            // Apenas um set de headers padr√£o para n√£o sobrecarregar
            const defaultHeaders = {
                'apikey': token,
                'Content-Type': 'application/json'
            };

            for (const test of tests) {
                if (success) break;
                try {
                    // Aumentamos o timeout para 30 segundos (contas com muitos grupos demoram)
                    const response = await fetchWithTimeout(test.url, { headers: defaultHeaders }, 30000);

                    if (response.ok) {
                        const data = await response.json();
                        let groups = [];

                        if (test.type === 'chats') {
                            groups = (Array.isArray(data) ? data : (data.chats || [])).filter(c => c.id?.endsWith('@g.us') || c.jid?.endsWith('@g.us'));
                        } else {
                            // Suporte a diferentes formatos de resposta da Evolution
                            groups = Array.isArray(data) ? data : (data.groups || data.instances || data.data || []);
                        }

                        if (Array.isArray(groups)) {
                            renderGroupsList(groups);
                            window.lastWorkingBase = test.url.split(test.type === 'chats' ? '/chat/' : '/group/')[0];
                            success = true;
                            break;
                        }
                    } else {
                        // Se der erro 401/403, pode ser o header alternativo necess√°rio
                        if (response.status === 401 || response.status === 403) {
                            const altHeaders = { 'api-key': token, 'Content-Type': 'application/json' };
                            const altResponse = await fetchWithTimeout(test.url, { headers: altHeaders }, 30000);
                            if (altResponse.ok) {
                                const altData = await altResponse.json();
                                let altGroups = Array.isArray(altData) ? altData : (altData.groups || altData.chats || altData.data || []);
                                if (Array.isArray(altGroups)) {
                                    renderGroupsList(altGroups);
                                    success = true;
                                    break;
                                }
                            }
                        }
                        logRelatorio.push(`Erro ${response.status} na rota: ${test.url.replace(cleanBase, '')}`);
                    }
                } catch (e) {
                    const errorMsg = e.message.includes('aborted') ? 'Tempo esgotado (30s)' : e.message.substring(0, 30);
                    logRelatorio.push(`Falha: ${errorMsg}`);
                }
            }

            if (!success) {
                container.innerHTML = `
                    <div style="padding: 30px; text-align: center; color: var(--danger);">
                        <i data-lucide="alert-octagon" style="width: 40px; height: 40px; margin-bottom: 10px;"></i>
                        <h4 style="color:#fff;">Ocorreu um Problema na Extra√ß√£o</h4>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px;">N√£o conseguimos listar os grupos da inst√¢ncia <b>${instance}</b>.</p>
                        
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: left; font-family: monospace; font-size: 0.65rem; max-height: 120px; overflow-y: auto; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);">
                            ${logRelatorio.map(l => `<div style="margin-bottom:4px;">‚Ä¢ ${l}</div>`).join('')}
                        </div>

                        <button class="btn btn-primary" onclick="loadWhatsAppGroups()" style="width: auto; margin: 0 auto; background: var(--primary);">
                             Tentar Novamente
                        </button>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // Fun√ß√£o auxiliar para fetch com timeout
        async function fetchWithTimeout(url, options = {}, timeout = 10000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(url, { ...options, signal: controller.signal });
                clearTimeout(id);
                return response;
            } catch (e) {
                clearTimeout(id);
                throw e;
            }
        }

        function renderGroupsList(groups) {
            const container = document.getElementById('groups_container');
            container.innerHTML = '';

            if (!groups || groups.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center;">Nenhum grupo encontrado nesta conta.</div>';
                return;
            }

            groups.forEach(g => {
                const item = document.createElement('div');
                item.style = "padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s;";
                item.onmouseover = () => item.style.background = "rgba(255,255,255,0.05)";
                item.onmouseout = () => item.style.background = "transparent";

                const gId = g.id || g.jid || (g.id && g.id._serialized) || "";
                const gSubject = g.subject || g.name || "Grupo Sem Nome";

                item.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="width: 40px; height: 40px; background: #222; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i data-lucide="users" style="width: 20px; color: var(--primary)"></i>
                        </div>
                        <div>
                            <p style="font-weight: 700; margin: 0; font-size: 0.95rem;">${gSubject}</p>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin: 3px 0 0 0;">ID: ${gId}</p>
                        </div>
                    </div>
                    <button class="btn btn-outline" style="padding: 6px 15px; font-size: 0.8rem; height: auto;" onclick="extractFromGroup('${gId}', '${gSubject.replace(/'/g, "")}')">
                        Extrair
                    </button>
                `;
                container.appendChild(item);
            });
            lucide.createIcons();
        }

        async function extractFromGroup(groupId, subject) {
            showToast(`Extraindo de ${subject}...`, "info");

            const selectedKey = document.getElementById('extractorInstanceSelector').value;
            const instObj = selectedKey === 'user' ? userInstance : partnerInstance;

            const base = window.lastWorkingBase || SAAS_CONFIG.baseUrl.replace(/\/+$/, '');
            const prefix = window.lastWorkingPrefix || '';
            const instance = instObj.name;
            const token = instObj.token;

            const routes = [
                `/group/findGroupInfos/${instance}?groupJid=${groupId}`,
                `/group/getParticipants/${instance}?groupJid=${groupId}`,
                `/group/participants/${instance}?groupJid=${groupId}`,
                `/group/members/${instance}/${groupId}`
            ];

            let success = false;
            let contactsMap = new Map();

            for (const route of routes) {
                try {
                    const fullUrl = `${base}${prefix}${route}`;
                    let response = await fetchWithTimeout(fullUrl, { headers: { 'apikey': token } });
                    if (!response.ok) response = await fetchWithTimeout(fullUrl, { headers: { 'apikey': SAAS_CONFIG.globalKey } });

                    if (response.ok) {
                        const data = await response.json();
                        let members = Array.isArray(data) ? data :
                            (data.participants ||
                                data.members ||
                                (data.groupInfo ? data.groupInfo.participants : null) ||
                                (data.data ? (data.data.participants || data.data) : []));

                        if (Array.isArray(members) && members.length > 0) {
                            members.forEach(m => {
                                let phone = "";
                                let name = "Membro do Grupo";

                                if (typeof m === 'object' && m !== null) {
                                    // Pega o nome se dispon√≠vel
                                    name = m.name || m.pushName || m.notify || m.verifiedName || "Membro do Grupo";

                                    // L√≥gica Refinada: Prioriza n√∫mero real sobre IDs de privacidade (LID)
                                    // Algumas APIs retornam o n√∫mero real em "number" ou "phoneNumber" mesmo com JID sendo LID
                                    let phoneNumber = m.phoneNumber || m.number || m.senderPn || (m.id && m.id.user ? m.id.user : "");
                                    let jid = m.jid || (m.id && typeof m.id === 'string' ? m.id : (m.id && m.id._serialized ? m.id._serialized : ""));
                                    let user = m.user || "";

                                    // 1. Tenta pegar o n√∫mero limpo de campos expl√≠citos (se for < 14 d√≠gitos, provavelmente √© fone real)
                                    let cleanNum = phoneNumber.toString().replace(/\D/g, '');
                                    if (cleanNum && cleanNum.length <= 13 && cleanNum.length >= 8) {
                                        phone = cleanNum;
                                    }
                                    // 2. Se o JID for o padr√£o (s.whatsapp.net), ele cont√©m o n√∫mero real
                                    else if (jid.includes('@s.whatsapp.net')) {
                                        phone = jid.split('@')[0].split(':')[0].replace(/\D/g, '');
                                    }
                                    // 3. Se for um LID, mantemos o JID completo
                                    else if (jid.includes('@lid') || jid.includes('@l.io')) {
                                        phone = jid;
                                    }
                                    // 4. Fallback inteligente
                                    else {
                                        let raw = (user || jid || m.toString()).toString();
                                        let cleanDigits = raw.split('@')[0].split(':')[0].replace(/\D/g, '');
                                        if (cleanDigits.length > 13 || raw.includes('@lid')) {
                                            phone = cleanDigits.includes('@') ? cleanDigits : cleanDigits + "@lid";
                                        } else if (cleanDigits.length >= 8) {
                                            phone = cleanDigits;
                                        }
                                    }
                                } else {
                                    phone = m.toString();
                                }

                                if (phone && !contactsMap.has(phone)) {
                                    contactsMap.set(phone, name);
                                }
                            });
                            success = true;
                        }
                    }
                } catch (e) {
                    console.error("Erro na rota:", route, e);
                }
            }

            if (success) {
                lastExtractedContacts = Array.from(contactsMap.entries()).map(([phone, name]) => ({ phone, name }));
                document.getElementById('extracted_count').innerText = lastExtractedContacts.length;
                document.getElementById('extraction_stats').style.display = 'block';
                document.getElementById('downloadExtractBtn').disabled = false;

                const lids = lastExtractedContacts.filter(c => c.phone.includes('@')).length;
                const numbers = lastExtractedContacts.length - lids;

                if (lids > 0) {
                    showToast(`Extra√ß√£o Conclu√≠da: ${numbers} n√∫meros e ${lids} IDs de privacidade capturados. Pronto para o envio!`, "success");
                } else {
                    showToast(`${lastExtractedContacts.length} contatos extra√≠dos com sucesso!`, "success");
                }

                // Ativa o bot√£o de c√≥pia tbm
                document.getElementById('copyExtractBtn').disabled = false;
            } else {
                showToast("N√£o foi poss√≠vel obter os n√∫meros. Tente reconectar a inst√¢ncia.", "error");
            }
        }

        async function exportExtractedContacts() {
            try {
                let xl = window.XLSX || (typeof XLSX !== 'undefined' ? XLSX : null);
                if (!lastExtractedContacts || lastExtractedContacts.length === 0) return showToast("Nenhum contato.", "error");
                if (!xl) return showToast("Biblioteca de Excel n√£o encontrada.", "error");

                showToast("Gerando arquivo Excel...", "info");

                const data = lastExtractedContacts.map(c => ({ "Telefone": c.phone }));
                const worksheet = xl.utils.json_to_sheet(data);
                const workbook = xl.utils.book_new();
                xl.utils.book_append_sheet(workbook, worksheet, "Contatos");

                try {
                    // M√©todo Base64 - Extremamente est√°vel em navegadores e Electron
                    const wbout = xl.write(workbook, { bookType: 'xlsx', type: 'base64' });
                    const url = "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," + wbout;

                    const link = document.createElement("a");
                    link.href = url;
                    link.download = `Extracao_ZapElite_${new Date().getTime()}.xlsx`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showToast("Planilha baixada!", "success");
                } catch (err) {
                    console.error("Erro no download:", err);
                    showToast("Erro ao processar o arquivo.", "error");
                }
            } catch (error) {
                console.error("Falha fatal na exporta√ß√£o:", error);
                showToast("Erro ao exportar contatos.", "error");
            }
        }

        function copyExtractedContacts() {
            if (!lastExtractedContacts || lastExtractedContacts.length === 0) return;
            const text = lastExtractedContacts.map(c => c.phone).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                showToast("Lista copiada para a √°rea de transfer√™ncia!", "success");
            }).catch(err => {
                showToast("Erro ao copiar lista.", "error");
            });
        }

        // --- WARMUP ENGINE (ELITE MODE) ---
        let isWarmupRunning = false;
        let warmupStopRequested = false;
        let warmupCount = 0;
        let warmupStartTime = null;

        const warmupPhrases = [
            "Oi, tudo bem?", "E a√≠, como est√£o as coisas?", "Vi sua mensagem agora.",
            "Beleza, combinamos assim.", "Pode falar agora?", "Bom dia!",
            "Opa, salve!", "Cara, voc√™ n√£o sabe o que aconteceu...",
            "Depois me liga.", "T√¥ chegando a√≠.", "Manda o link de novo?",
            "Show de bola.", "Fechou ent√£o.", "Pode ser amanh√£?",
            "Vou ver aqui e te falo.", "Tranquilo.", "Opa!", "E a√≠, par√ßa?",
            "Tudo na paz por aqui.", "Como foi seu dia?", "Ontem foi corrido.",
            "J√° viu aquele v√≠deo?", "Manda a localiza√ß√£o.", "Queria te perguntar uma coisa.",
            "Cara, perai que t√¥ dirigindo.", "Vou te mandar um √°udio.", "Amanh√£ a gente se fala.",
            "Valeu!", "Abra√ßo!", "Tamo junto.", "Top demais."
        ];

        function getWarmupPhrase() {
            const base = warmupPhrases[Math.floor(Math.random() * warmupPhrases.length)];
            const prefixes = ["", "", "", "Ei, ", "Opa, ", "Cara, "];
            const suffixes = ["", "", " üëç", " !!", "...", " hehe"];
            return prefixes[Math.floor(Math.random() * prefixes.length)] + base + suffixes[Math.floor(Math.random() * suffixes.length)];
        }

        async function startWarmup() {
            if (!userInstance.connected) {
                showToast("Conecte seu WhatsApp antes de aquecer!", "error");
                showTab('settings');
                return;
            }



            isWarmupRunning = true;
            warmupStopRequested = false;
            warmupCount = 0;
            warmupStartTime = Date.now();

            document.getElementById('warmupStartBtn').disabled = true;
            document.getElementById('warmupStopBtn').disabled = false;
            document.getElementById('warmup_status_box').style.display = 'block';
            document.getElementById('warmup_logs').innerHTML = '';

            addWarmupLog("Iniciando mapeamento de inst√¢ncias...", "info");

            let mainNum = null;
            let secondNum = null;

            try {
                const infoRes = await fetch(`${SAAS_CONFIG.baseUrl}/instance/fetchInstances`, {
                    headers: { 'apikey': SAAS_CONFIG.globalKey }
                });
                const infoData = await infoRes.json();
                const list = Array.isArray(infoData) ? infoData : (infoData.instances || []);

                // Busca profunda pela inst√¢ncia principal
                const mainData = list.find(i =>
                    (i.name && i.name === userInstance.name) ||
                    (i.instanceName && i.instanceName === userInstance.name) ||
                    (i.instance && i.instance.instanceName === userInstance.name)
                );

                if (mainData) {
                    addWarmupLog(`Inst√¢ncia 01 encontrada na lista. Verificando JID...`, "info");
                    const jid = mainData.ownerJid || mainData.owner || mainData.jid || (mainData.instance && (mainData.instance.ownerJid || mainData.instance.owner || mainData.instance.jid));
                    if (jid) {
                        mainNum = jid.split('@')[0];
                        addWarmupLog(`Inst√¢ncia 01 mapeada: ${mainNum}`, "success");
                    } else {
                        addWarmupLog(`Aviso: Inst√¢ncia 01 identificada, mas o n√∫mero (JID) n√£o foi encontrado no objeto.`, "warning");
                    }
                } else {
                    addWarmupLog(`Aviso: Inst√¢ncia 01 offline no servidor.`, "warning");
                }

                // Busca profunda pela inst√¢ncia secund√°ria
                const secondData = list.find(i =>
                    (i.name && i.name === partnerInstance.name) ||
                    (i.instanceName && i.instanceName === partnerInstance.name) ||
                    (i.instance && i.instance.instanceName === partnerInstance.name)
                );

                if (secondData) {
                    const jid = secondData.ownerJid || secondData.owner || secondData.jid || (secondData.instance && (secondData.instance.ownerJid || secondData.instance.owner || secondData.instance.jid));
                    if (jid) {
                        secondNum = jid.split('@')[0];
                        partnerInstance.connected = true;
                        addWarmupLog(`Inst√¢ncia 02 mapeada: ${secondNum}`, "success");
                    } else {
                        addWarmupLog(`Aviso: Inst√¢ncia 02 encontrada, mas n√∫mero (JID) ausente.`, "warning");
                    }
                } else {
                    addWarmupLog(`Inst√¢ncia 02 ("${partnerInstance.name}") offline ou n√£o mapeada.`, "info");
                }

                if (mainNum && secondNum && partnerInstance.connected) {
                    addWarmupLog("Modo Ping-Pong Elite Ativado!", "success");
                } else {
                    addWarmupLog("Aviso: Conecte ambas as inst√¢ncias para o matura√ß√£o Ping-Pong!", "warning");
                    showToast("Conecte os dois WhatsApps para o Aquecimento!", "info");
                    isWarmupRunning = false;
                    document.getElementById('warmupStartBtn').disabled = false;
                    document.getElementById('warmupStopBtn').disabled = true;
                    return;
                }
            } catch (e) {
                console.error("Erro na detec√ß√£o inicial:", e);
                addWarmupLog(`Erro fatal no mapeamento: ${e.message}`, "error");
            }

            while (!warmupStopRequested) {
                const phrase = getWarmupPhrase();
                const speed = document.getElementById('warmup_speed').value;

                updateWarmupStatus("Simulando Digita√ß√£o...", `Preparando: "${phrase.substring(0, 15)}..."`);

                let senderInstance = userInstance;
                if (partnerInstance.connected && mainNum && secondNum) {
                    if (warmupCount % 2 === 0) {
                        senderInstance = userInstance;
                        recipientNum = secondNum;
                        senderLabel = "PRINCIPAL -> SECUND√ÅRIO";
                    } else {
                        senderInstance = partnerInstance;
                        recipientNum = mainNum;
                        senderLabel = "SECUND√ÅRIO -> PRINCIPAL";
                    }
                } else {
                    // Fallback de seguran√ßa (n√£o deve atingir aqui devido ao check acima)
                    addWarmupLog("Falha cr√≠tica no mapeamento de rota.", "error");
                    break;
                }

                updateWarmupStatus("Simulando Digita√ß√£o...", `[${senderLabel}] Preparando...`);

                try {
                    await fetch(`${SAAS_CONFIG.baseUrl}/instance/setPresence/${senderInstance.name}`, {
                        method: 'POST',
                        headers: { 'apikey': senderInstance.token, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ presence: 'composing' })
                    });
                } catch (e) { }

                const typingTime = speed === 'turbo' ? (Math.floor(Math.random() * 2000) + 1000) : (Math.floor(Math.random() * 4000) + 2000);
                await new Promise(r => setTimeout(r, typingTime));

                try {
                    const res = await sendEvolution(recipientNum, phrase, {
                        baseUrl: SAAS_CONFIG.baseUrl,
                        token: senderInstance.token,
                        instance: senderInstance.name
                    });

                    if (res.key || res.status === 'SUCCESS' || res.status === 200) {
                        warmupCount++;
                        addWarmupLog(`[${senderLabel}] Mensagem: ${phrase}`, "success");
                        updateWarmupStats();
                    } else {
                        addWarmupLog(`Erro no envio: ${res.message || 'Desconhecido'}`, "danger");
                    }
                } catch (e) {
                    addWarmupLog(`Falha de conex√£o: ${e.message}`, "error");
                }

                if (warmupStopRequested) break;

                // INTERVALO DE VELOCIDADE (Ajustado para conversa real)
                let waitTime = 30000;
                if (speed === 'turbo') waitTime = Math.floor(Math.random() * 5000) + 3000; // 3-8s
                else if (speed === 'fast') waitTime = Math.floor(Math.random() * 10000) + 7000; // 7-17s
                else if (speed === 'human') waitTime = Math.floor(Math.random() * 40000) + 20000; // 20-60s
                else if (speed === 'caotic') waitTime = Math.floor(Math.random() * 120000) + 5000; // 5s a 2 min

                updateWarmupStatus("Aguardando...", `Pr√≥xima em ${Math.round(waitTime / 1000)} segundos`);
                await new Promise(r => setTimeout(r, waitTime));
            }

            addWarmupLog("Aquecimento finalizado pelo usu√°rio.", "info");
            updateWarmupStatus("Motor Parado", "Sess√£o encerrada.");
            document.getElementById('warmupStartBtn').disabled = false;
            document.getElementById('warmupStopBtn').disabled = true;
        }

        function stopWarmup() {
            warmupStopRequested = true;
            document.getElementById('warmupStopBtn').disabled = true;
            addWarmupLog("Solicitando parada segura...", "info");
        }

        function updateWarmupStatus(title, detail) {
            document.getElementById('warmup_status_text').innerText = title;
            document.getElementById('warmup_status_detail').innerText = detail;
        }

        function updateWarmupStats() {
            document.getElementById('warmup-stat-sent').innerText = warmupCount;
            const minutes = Math.floor((Date.now() - warmupStartTime) / 60000);
            document.getElementById('warmup-stat-time').innerText = minutes + "m";

            let trust = "Frio";
            let color = "#ff4444";
            if (warmupCount > 10) { trust = "Morno"; color = "#ff9800"; }
            if (warmupCount > 30) { trust = "Aquecendo"; color = "#ffeb3b"; }
            if (warmupCount > 60) { trust = "Quente"; color = "#1ed760"; }
            if (warmupCount > 100) { trust = "ELITE"; color = "#00e676"; }

            const trustEl = document.getElementById('warmup-stat-trust');
            trustEl.innerText = trust;
            trustEl.style.color = color;
        }

        function addWarmupLog(msg, type) {
            const container = document.getElementById('warmup_logs');
            if (container) {
                const entry = document.createElement('div');
                const color = type === 'success' ? '#1ed760' : (type === 'error' ? '#ff4444' : '#888');
                entry.style = `padding: 5px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); color: ${color};`;
                entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
                container.prepend(entry);
            }
        }

        // --- PARTNER INSTANCE LOGIC ---
        async function createPartnerInstance() {
            const name = "parceiro_" + Math.floor(Math.random() * 9000 + 1000);
            const token = generateSecureToken();

            document.getElementById('partner_setup_view').style.display = 'none';
            document.getElementById('partner_qr_view').style.display = 'block';
            document.getElementById('partner_qr_container').innerHTML = '<div style="padding:20px;"><i data-lucide="loader-2" class="spin"></i><p style="font-size:0.7rem; margin-top:10px;">Criando Inst√¢ncia...</p></div>';
            lucide.createIcons();

            try {
                const res = await fetch(`${SAAS_CONFIG.baseUrl}/instance/create`, {
                    method: 'POST',
                    headers: { 'apikey': SAAS_CONFIG.globalKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instanceName: name,
                        token: token,
                        qrcode: true,
                        integration: "WHATSAPP-BAILEYS"
                    })
                });
                const data = await res.json();

                if (res.status === 201 || data.instance) {
                    partnerInstance.name = name;
                    partnerInstance.token = token;
                    localStorage.setItem('zapelite_partner_name', name);
                    localStorage.setItem('zapelite_partner_token', token);
                    fetchPartnerQRCode();
                    startPartnerPolling();
                } else {
                    showToast("Erro ao criar parceiro. Tente novamente.", "error");
                    document.getElementById('partner_setup_view').style.display = 'block';
                    document.getElementById('partner_qr_view').style.display = 'none';
                }
            } catch (e) {
                showToast("Falha de conex√£o com servidor.", "error");
            }
        }

        async function fetchPartnerQRCode() {
            if (partnerInstance.connected) return;
            try {
                const res = await fetch(`${SAAS_CONFIG.baseUrl}/instance/connect/${partnerInstance.name}`, {
                    headers: { 'apikey': partnerInstance.token }
                });
                const data = await res.json();
                if (data.base64) {
                    document.getElementById('partner_qr_container').innerHTML = `<img src="${data.base64}" style="width:180px; height:180px; border-radius:10px;">`;
                } else {
                    setTimeout(fetchPartnerQRCode, 3000);
                }
            } catch (e) {
                setTimeout(fetchPartnerQRCode, 5000);
            }
        }

        let partnerPoll;
        function startPartnerPolling() {
            if (partnerPoll) clearInterval(partnerPoll);
            partnerPoll = setInterval(checkPartnerStatus, 4000);
        }

        async function checkPartnerStatus() {
            if (!partnerInstance.name) return;
            try {
                const res = await fetch(`${SAAS_CONFIG.baseUrl}/instance/connectionState/${partnerInstance.name}`, {
                    headers: { 'apikey': partnerInstance.token }
                });
                const data = await res.json();
                const isConnected = data.instance && data.instance.state === 'open';

                if (isConnected && !partnerInstance.connected) {
                    partnerInstance.connected = true;
                    showToast("Chip Parceiro Conectado!", "success");
                    updatePartnerUI();
                } else if (!isConnected && partnerInstance.connected) {
                    partnerInstance.connected = false;
                    updatePartnerUI();
                }
            } catch (e) { }
        }

        function updatePartnerUI() {
            if (partnerInstance.connected) {
                document.getElementById('partner_setup_view').style.display = 'none';
                document.getElementById('partner_qr_view').style.display = 'none';
                document.getElementById('partner_connected_view').style.display = 'block';
                document.getElementById('partner_display_name').innerText = partnerInstance.name;
                document.getElementById('partner_status_badge').innerHTML = '<span class="status-badge status-online">Conectado</span>';
            } else if (partnerInstance.name) {
                document.getElementById('partner_setup_view').style.display = 'none';
                document.getElementById('partner_qr_view').style.display = 'block';
                document.getElementById('partner_connected_view').style.display = 'none';
                document.getElementById('partner_status_badge').innerHTML = '<span class="status-badge status-sending">Aguardando QR</span>';
            } else {
                document.getElementById('partner_setup_view').style.display = 'block';
                document.getElementById('partner_qr_view').style.display = 'none';
                document.getElementById('partner_connected_view').style.display = 'none';
                document.getElementById('partner_status_badge').innerHTML = '<span class="status-badge status-offline">Desconectado</span>';
            }
            lucide.createIcons();
        }

        async function disconnectPartner() {
            if (partnerInstance.name) {
                try {
                    await fetch(`${SAAS_CONFIG.baseUrl}/instance/delete/${partnerInstance.name}`, {
                        method: 'DELETE',
                        headers: { 'apikey': SAAS_CONFIG.globalKey }
                    });
                } catch (e) { }
            }
            localStorage.removeItem('zapelite_partner_name');
            localStorage.removeItem('zapelite_partner_token');
            partnerInstance = { name: '', token: '', connected: false };
            if (partnerPoll) clearInterval(partnerPoll);
            updatePartnerUI();
        }
    </script>

    <!-- Modal de Confirma√ß√£o de Campanha -->
    <div id="confirmOverlay" class="confirm-overlay">
        <div class="confirm-card">
            <i data-lucide="shield-check"
                style="width: 50px; height: 50px; color: var(--primary); margin-bottom: 20px;"></i>
            <h2 style="font-size: 1.5rem; margin-bottom: 15px;">Confirmar Disparo?</h2>
            <div id="confirmDetails"
                style="text-align: left; background: rgba(255,255,255,0.03); padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid var(--border);">
                <!-- Preenchido via JS -->
            </div>
            <div style="display: flex; gap: 15px;">
                <button class="btn btn-outline" onclick="closeConfirmModal()" style="flex: 1;">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmCampaign()" style="flex: 1;">Sim, Iniciar</button>
            </div>
        </div>
    </div>
</body>

</html>